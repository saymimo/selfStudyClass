<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ProjectPactMapper" >
  <resultMap id="BaseResultMap" type="com.ssc.entity.system.ProjectPact" >
    <id column="PROJECT_PACT_ID" property="projectPactId" jdbcType="VARCHAR" />
    <result column="STRUCT_ID" property="structId" jdbcType="VARCHAR" />
    <result column="ITEM_ID" property="itemId" jdbcType="VARCHAR" />
    <result column="USER_ID" property="userId" jdbcType="VARCHAR" />
    <result column="RECORD_NUMBER" property="recordNumber" jdbcType="VARCHAR" />
    <result column="PROJECT_NAME" property="projectName" jdbcType="VARCHAR" />
    <result column="BUILD_UNIT" property="buildUnit" jdbcType="VARCHAR" />
    <result column="PROJECT_MANAGER" property="projectManager" jdbcType="VARCHAR" />
    <result column="ACTUAL_DUTY" property="actualDuty" jdbcType="VARCHAR" />
    <result column="MONEY" property="money" jdbcType="DECIMAL" />
    <result column="AREA" property="area" jdbcType="VARCHAR" />
    <result column="STRUCTURE" property="structure" jdbcType="DECIMAL" />
    <result column="PROJECT_TYPE" property="projectType" jdbcType="VARCHAR" />
    <result column="SCHEDULE" property="schedule" jdbcType="VARCHAR" />
    <result column="MAKE_DATE" property="makeDate" jdbcType="TIMESTAMP" />
    <result column="START_DATE" property="startDate" jdbcType="TIMESTAMP" />
    <result column="END_DATE" property="endDate" jdbcType="TIMESTAMP" />
    <result column="ACTUAL_START_DATE" property="actualStartDate" jdbcType="TIMESTAMP" />
    <result column="ACTUAL_END_DATE" property="actualEndDate" jdbcType="TIMESTAMP" />
    <result column="NOTIFY_DATE" property="notifyDate" jdbcType="TIMESTAMP" />
    <result column="CHECK_DATE" property="checkDate" jdbcType="TIMESTAMP" />
    <result column="PRIZE_REMARK" property="prizeRemark" jdbcType="VARCHAR" />
    <result column="BID_DATE" property="bidDate" jdbcType="TIMESTAMP" />
    <result column="BID_MONEY" property="bidMoney" jdbcType="DECIMAL" />
    <result column="PACT_NUM" property="pactNum" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="STATE" property="state" jdbcType="INTEGER" />
    <result column="IS_DEL" property="isDel" jdbcType="INTEGER" />
    <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="CREATE_BY" property="createBy" jdbcType="VARCHAR" />
    <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP" />
    <result column="UPDATE_BY" property="updateBy" jdbcType="VARCHAR" />
    <result column="PACT_NATURE" property="pactNature" jdbcType="VARCHAR"/>
    <result column="LOAN_STATE" property="loanState" jdbcType="INTEGER"/>
    <result column="STRUCTURE_TYPE" property="structureType" jdbcType="VARCHAR"/>
    <result column="IS_FORMAL" property="isFormal" jdbcType="INTEGER"/>
  </resultMap>
  <sql id="Base_Column_List" >
    PROJECT_PACT_ID, ITEM_ID, USER_ID, RECORD_NUMBER, PROJECT_NAME, BUILD_UNIT, PROJECT_MANAGER, STRUCT_ID,
    ACTUAL_DUTY, MONEY, AREA, STRUCTURE, PROJECT_TYPE, SCHEDULE, MAKE_DATE, START_DATE, 
    END_DATE, ACTUAL_START_DATE, ACTUAL_END_DATE, NOTIFY_DATE, CHECK_DATE, PRIZE_REMARK, 
    BID_DATE, BID_MONEY, PACT_NUM, REMARK, STATE, IS_DEL, CREATE_DATE, CREATE_BY, UPDATE_DATE,PACT_NATURE, 
    UPDATE_BY,PROVINCE,CITY,ADDRESS,LOAN_STATE,IS_HISTORY,STRUCTURE_TYPE
  </sql>
  
<!-- 主页面显示  合同管理 -->
<select id="listPageAll" parameterType="page" resultType="pd">
SELECT 
    tpi.PROJECT_PACT_ID, tp.ITEM_ID, tpi.USER_ID, tpi.RECORD_NUMBER, tpi.PROJECT_NAME, tpi.BUILD_UNIT, tpi.PROJECT_MANAGER, tp.STRUCT_ID,
    tpi.ACTUAL_DUTY, tpi.MONEY, tpi.AREA, tpi.STRUCTURE, tpi.PROJECT_TYPE, tpi.SCHEDULE, tpi.MAKE_DATE, tpi.START_DATE, 
    tpi.END_DATE, tpi.ACTUAL_START_DATE, tpi.ACTUAL_END_DATE, tpi.NOTIFY_DATE, tpi.CHECK_DATE, tpi.PRIZE_REMARK, 
    tpi.BID_DATE, tpi.BID_MONEY, tpi.PACT_NUM, tpi.REMARK, tpi.STATE, tpi.IS_DEL, tpi.CREATE_DATE, tpi.CREATE_BY, tpi.UPDATE_DATE,tpi.PACT_NATURE, 
    tpi.UPDATE_BY,tpi.PROVINCE,tpi.CITY,tpi.ADDRESS,tp.LOAN_STATE,tpi.IS_HISTORY,
  (SELECT 
    tt.`ITEM_NAME` 
  FROM
    tt_iteminfo tt 
  WHERE tt.`ITEM_ID` = tp.`ITEM_ID`) ITEM_NAME,
  (SELECT 
    NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tpi.`CREATE_BY`) AS CREATE_NAME,
  (SELECT 
    NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tpi.`USER_ID`) USER_NAME,
  TIMESTAMPDIFF(DAY, tpi.START_DATE, tpi.END_DATE) AS DAYS,
  (SELECT 
    su.NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tpi.`PROJECT_MANAGER`) PROJECT_MANAGER_NAME,
  (SELECT 
    sd.NAME 
  FROM
    sys_dictionaries sd 
  WHERE sd.P_BM = tp.`PROJECT_TYPE`) PROJECT_TYPE_NAME,
  CASE
    (SELECT COUNT(*)
      FROM tt_tribune tr WHERE tr.REVIEW_OBJ_ID =tp.PROJECT_PACT_ID ) 
    WHEN 0 
    THEN 'no' 
    ELSE 'yes' 
  END isReview,
  (SELECT 
    tt.STATE 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) reviewState,
  (SELECT 
    TRIBUNE_ID 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) TRIBUNE_ID,
  (SELECT STRUCT_NAME FROM sys_structinfo s WHERE s.STRUCT_ID = tp.STRUCT_ID)  STRUCT_NAME,
  tp.COLOR,tp.ZB_COLOR,tp.JB_COLOR 
FROM
  tt_project_pact tp 
  LEFT JOIN tt_project_inside_pact tpi 
    ON tpi.`PROJECT_PACT_ID` = tp.`PROJECT_PACT_ID` and tpi.`IS_DEL` = 0 
WHERE tp.`IS_DEL` = 0
and tp.PARENT_ID is  null

<if test="pd.selColor !=null and pd.selColor!='' ">
	AND tp.COLOR=#{pd.selColor}
</if>

<if test="pd.dSCengCi !=null and pd.dSCengCi!='' ">
	AND tp.OVERGROUND  like  CONCAT(CONCAT('%', #{pd.dSCengCi}),'%')
</if>

<if test="pd.dXCengCi !=null and pd.dXCengCi!='' ">
	AND tp.UNDERGROUND like  CONCAT(CONCAT('%', #{pd.dXCengCi}),'%') 
</if>
<if test="pd.isReview == 'yes' ">
	AND tp.STRUCT_ID=#{pd.structId}
</if>
<if test="pd.AREA !=null and pd.AREA != '' ">
	AND tp.AREA like  CONCAT(CONCAT('%', #{pd.AREA}),'%') 
</if>

<if test="pd.NOTIFY_DATE == 'isNull' ">
	AND (tp.`NOTIFY_DATE` IS NULL OR tp.`NOTIFY_DATE` ='')
</if>
<if test="pd.CHECK_DATE == 'isNull' ">
	AND (tp.`CHECK_DATE` IS NULL OR tp.`CHECK_DATE` ='')
</if>
<if test="pd.NOTIFY_DATE == 'has' ">
	AND (tp.`NOTIFY_DATE` IS NOT NULL AND tp.`NOTIFY_DATE` !='')
</if>
<if test="pd.CHECK_DATE == 'has' ">
	AND (tp.`CHECK_DATE` IS NOT NULL AND tp.`CHECK_DATE` !='')
</if>
<if test="pd.certifiState !=null and pd.certifiState != '' ">
AND  tp.LOAN_STATE=#{pd.certifiState}
</if>

<if test="pd.PROVINCE !=null and pd.PROVINCE != '' ">
AND tpi.PROVINCE=#{pd.PROVINCE} 
 </if>
 
<if test="pd.STATMONEY !=null and pd.STATMONEY != '' ">
AND   tpi.MONEY &gt;=#{pd.STATMONEY}
</if>
<if test="pd.ENDMONEY !=null and pd.ENDMONEY != '' ">
AND   tpi.MONEY &lt;=#{pd.ENDMONEY}
</if>

<if test="pd.STAT_STRUCTURE !=null and pd.STAT_STRUCTURE != '' ">
AND   tpi.STRUCTURE &gt;=#{pd.STAT_STRUCTURE}
</if>
<if test="pd.END_STRUCTURE !=null and pd.END_STRUCTURE != '' ">
AND   tpi.STRUCTURE &lt;=#{pd.END_STRUCTURE}
</if>

<if test="pd.PROJECTTYPE !=null and pd.PROJECTTYPE != ''">
AND   tpi.PROJECT_TYPE =#{pd.PROJECTTYPE}
</if>
 <if test="pd.STATE_TYPE !=null and pd.STATE_TYPE != '' and pd.STATE_TYPE != 'ss'">
AND   tp.STATE =#{pd.STATE_TYPE}
</if>
<if test="pd.STRUCTID !=null and pd.STRUCTID != '' ">
	AND tp.STRUCT_ID=#{pd.STRUCTID}
</if>   
<if test="pd.PACTNATURE !=null and pd.PACTNATURE != '' ">
	 AND tp.`PACT_NATURE`   LIKE CONCAT('%',#{pd.PACTNATURE}, '%')
</if>    
     

  <if test="pd.ITEMCOLLECTNAME != null and pd.ITEMCOLLECTNAME != ''">
  and (
  tpi.`RECORD_NUMBER` LIKE #{pd.ITEMCOLLECTNAME2}
  OR tpi.`PROJECT_NAME` LIKE #{pd.ITEMCOLLECTNAME2}
  OR tpi.`BUILD_UNIT` LIKE #{pd.ITEMCOLLECTNAME2}
  OR tpi.PRIZE_REMARK LIKE #{pd.ITEMCOLLECTNAME2}
  or (SELECT s.`NAME` FROM `sys_user` s WHERE s.`USER_ID`=tp.`USER_ID`) LIKE CONCAT('%',#{pd.ITEMCOLLECTNAME2}, '%')
  )
  </if>
<if test="pd.lastLoginStart !=null and pd.lastLoginStart != '' ">
	AND tpi.`MAKE_DATE`  &gt;=#{pd.lastLoginStart}
</if>
<if test="pd.lastLoginEnd !=null and pd.lastLoginEnd != '' ">
 AND tpi.`MAKE_DATE` &lt;=#{pd.lastLoginEnd}
</if>

<if test="pd.checkDateStart !=null and pd.checkDateStart != '' ">
	AND tpi.`CHECK_DATE`  &gt;=#{pd.checkDateStart}
</if>
<if test="pd.checkDateEnd !=null and pd.checkDateEnd != '' ">
 AND tpi.`CHECK_DATE` &lt;=#{pd.checkDateEnd}
</if>

  ORDER BY tpi.RECORD_NUMBER,tpi.`CREATE_DATE` DESC
  
 


</select>   
  
  <!--查询 内部备案号-->
  <select id="findProjectPactByName" resultType="pd" parameterType="pd" >
    
     
     SELECT 
RECORD_NUMBER as NAME
FROM
  tt_project_pact  p 
  WHERE IS_DEL=0
 GROUP BY RECORD_NUMBER
     
  </select>
<select id="upTenderIsDel" parameterType="pd">
UPDATE 
  tt_tenderinfo t 
SET
  t.`IS_DEL` = 0
WHERE t.`PROJECT_PACT_ID` = #{projectPactId,jdbcType=VARCHAR}
</select>

<select id="structList" parameterType="pd" resultType="pd">
  SELECT t.`STRUCT_ID`,t.`STRUCT_NAME` FROM sys_structinfo t  WHERE t.`IS_DEL`=0
</select> 
<update id="upTenderIsItem" parameterType="pd">
UPDATE 
  tt_tenderinfo t 
SET
  t.`IS_ITEM` = 0,
  t.`PROJECT_PACT_ID` = NULL
WHERE t.`PROJECT_PACT_ID` = #{projectPactId,jdbcType=VARCHAR}
</update>
<select id="selectByPrimaryKey" resultType="pd" parameterType="pd" >
SELECT 
  pp.*,
  (SELECT 
    tt.`TRIBUNE_ID` 
  FROM
    tt_tribune tt 
  WHERE tt.`REVIEW_OBJ_ID` = pp.`PROJECT_PACT_ID`) TRIBUNE_ID,
  CASE
    (SELECT 
      STRUCTST_AGE 
    FROM
      sys_structinfo ss 
    WHERE ss.STRUCT_ID = pp.`STRUCT_ID`) 
    WHEN 0 
    THEN 'no' 
    ELSE 'yes' 
  END isReview ,
  IFNULL((SELECT STATE FROM tt_tribune t WHERE pp.PROJECT_PACT_ID = t.REVIEW_OBJ_ID),0) R_STATE
FROM
  tt_project_pact pp 
WHERE PROJECT_PACT_ID  = #{projectPactId,jdbcType=VARCHAR}
</select>

<select id="forReviewType" parameterType="pd" resultType="pd">
SELECT 
  * 
FROM
  tt_tribune tu 
WHERE tu.`TRIBUNE_ID` = #{tribuneId,jdbcType=VARCHAR}
</select>

<select id="userNames" parameterType="pd" resultType="String">
SELECT 
  GROUP_CONCAT(su.`NAME`) 
FROM
  tt_tribune_user tu,
  sys_user su 
WHERE su.`USER_ID` = tu.`USER_ID` 
  AND tu.`TRIBUNE_ID` = #{tribuneId,jdbcType=VARCHAR}
</select>

<delete id="dlReview" parameterType="pd">
DELETE 
FROM
  tt_tribune 
WHERE TRIBUNE_ID = #{tribuneId,jdbcType=VARCHAR}
</delete>
<delete id="dlReviewUser" parameterType="pd">
DELETE 
FROM
  tt_tribune_user 
WHERE TRIBUNE_ID = #{tribuneId,jdbcType=VARCHAR}
</delete>
<delete id="dlReviewReply" parameterType="pd">
DELETE 
FROM
  tt_tribune_user_reply 
WHERE TRIBUNE_ID = #{tribuneId,jdbcType=VARCHAR}
</delete>



  <update id="updateCertificateByState" parameterType="pd" >
UPDATE 
  tt_project_pact tp 
SET
  tp.`LOAN_STATE` = #{loanState} 
where PROJECT_PACT_ID = #{cityId}
  </update>


  <update id="updateCertificateByStateRetur" parameterType="pd" >
UPDATE 
  tt_project_pact tp 
SET
  tp.`LOAN_STATE` = #{loanState} 
where PROJECT_PACT_ID = #{cityId}
  </update>
  <update id="deleteByPrimaryKey" parameterType="pd" >
UPDATE 
  tt_project_pact tp 
SET
  tp.`IS_DEL` = 1,
  tp.UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
  tp.UPDATE_BY = #{updateBy,jdbcType=VARCHAR}
where PROJECT_PACT_ID = #{projectPactId,jdbcType=VARCHAR}
  </update>

<select id="certificateList" resultType="pd">
SELECT 
  u.`NAME`,
  u.`USER_ID`,
  tc.`CERTIFICATE_ID` 
FROM
  tt_certificate tc,
  sys_user u 
WHERE tc.`CERTIFICATE_PER` = 0 
  AND u.`USER_ID` = tc.`USER_ID` 
</select> 


<select id="aCertificate" resultType="pd" parameterType="pd">
SELECT 
  u.`NAME` AS USER_NAME,
  IFNULL(
    (
      CASE
        u.`SEX` 
        WHEN 0 
        THEN '男' 
        WHEN 1 
        THEN '女' 
      END
    ),
    ''
  ) SEX,
  IFNULL(u.`TECHNICAL_TITLE`, '') TECHNICAL_TITLE,
  IFNULL(u.`DIPLOMA`, '') DIPLOMA,
  IFNULL(u.`IDENTITYCODE`, '') IDENTITYCODE,
  (SELECT 
    GROUP_CONCAT(sd.NAME) 
  FROM
    sys_dictionaries sd 
  WHERE FIND_IN_SET(sd.BIANMA, tc.`TYPE`)) TYPE_NAME,
  IFNULL(tc.`CERTIFICATE_NO`, '') CERTIFICATE_NO,
  IFNULL(tc.`CERTIFICATE_NAME`, '') CERTIFICATE_NAME,
  SEND_DATE,
  SEND_UNIT,
  IFNULL(tc.`LEVEL`, '') LEVEL,
  CASE
    CERTIFICATE_STATE 
    WHEN 0 
    THEN '在库' 
    WHEN 1 
    THEN '申请中' 
    WHEN 2 
    THEN '集团寄出' 
    WHEN 3 
    THEN '已确认收' 
    WHEN 4 
    THEN '已归还' 
  END CERTIFICATE_STATE 
FROM
  tt_certificate tc,
  sys_user u 
WHERE tc.`CERTIFICATE_PER` = 0 
  AND tc.`USER_ID` = u.`USER_ID` 
  AND tc.`IS_DEL` = 0 
  AND tc.`USER_ID` = #{userId,jdbcType=VARCHAR} 
</select>

<select id="userList" resultType="pd">
SELECT 
  u.`USER_ID`,
  u.`NAME` 
FROM
  sys_user u 
</select>

<select id="checkNo" parameterType="pd"  resultType="Integer">
SELECT 
  COUNT(1) 
FROM
  tt_project_pact tp 
WHERE 1 = 1 
  AND tp.`IS_DEL` = 0 
<if test="projectPactId != null and projectPactId != ''">
  AND tp.`PROJECT_PACT_ID`  != #{projectPactId,jdbcType=VARCHAR} 
  </if>
<if test="recordNumber != null and recordNumber != ''"> 
  AND tp.`RECORD_NUMBER` = #{recordNumber,jdbcType=VARCHAR} 
  </if>
<if test="projectName != null and projectName != ''">
  AND tp.`PROJECT_NAME` = #{projectName,jdbcType=VARCHAR} 
  </if>
</select>

<select id="typeList" resultType="pd">
SELECT 
  sd.* 
FROM
  sys_dictionaries sd 
WHERE sd.`P_BM` LIKE 'ZYLB_%' 
</select>


<select id="rightReviewUser" parameterType="pd" resultType="pd">
SELECT 
  su.*,
  (SELECT 
    STRUCT_NAME 
  FROM
    sys_structinfo st 
  WHERE st.STRUCT_ID = su.`STRUCT_ID`) STRUCT_NAME  
FROM
  tt_tribune_user tu,
  sys_user su 
WHERE tu.`USER_ID` = su.`USER_ID` 
  AND tu.`TRIBUNE_ID` = #{tribuneId,jdbcType=VARCHAR}
</select>
<!-- 是否是合同管理员-->
<select id="isPactManager" parameterType="pd" resultType="String">
SELECT 
CASE 
WHEN #{userId,jdbcType=VARCHAR} IN(SELECT sr.`USER_ID`  FROM sys_user_role sr  WHERE sr.`ROLE_ID` IN (SELECT s.`ROLE_ID` FROM sys_role s WHERE s.`ROLE_CODE`='L_014'
))
THEN 'yes'
ELSE 'no'
END

</select>

<!-- 是否是分公司财务-->
<select id="isFinanceManager" parameterType="pd" resultType="String">
SELECT 
CASE 
WHEN #{userId,jdbcType=VARCHAR} IN(SELECT sr.`USER_ID`  FROM sys_user_role sr  WHERE sr.`ROLE_ID` IN (SELECT s.`ROLE_ID` FROM sys_role s WHERE s.`ROLE_CODE`='L_34'
))
THEN 'yes'
ELSE 'no'
END

</select>

<!-- 主页面显示 （合同选择）-->
<select id="listChosePageAll" parameterType="page" resultType="pd">
SELECT 
  sa.* 
FROM
  (SELECT 
    tp.*,
    (SELECT 
      tt.`ITEM_NAME` 
    FROM
      tt_iteminfo tt 
    WHERE tt.`ITEM_ID` = tp.`ITEM_ID`) ITEM_NAME,
    (SELECT CERTIFICATE_ID FROM `tt_certificate` p 
    WHERE p.USER_ID=tp.USER_ID AND p.CERTIFICATE_PER=0)AS CERTIFICATE_ID,
    (SELECT 
      NAME 
    FROM
      sys_user su 
    WHERE su.USER_ID = tp.`USER_ID`) USER_NAME,
    TIMESTAMPDIFF(DAY, START_DATE, END_DATE) AS DAYS,
     (SELECT 
    tt.STATE 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID)AS REVIEWSTATE,
    (SELECT 
      su.NAME 
    FROM
      sys_user su 
    WHERE su.USER_ID = tp.`PROJECT_MANAGER`) PROJECT_MANAGER_NAME,
    (SELECT 
      sd.NAME 
    FROM
      sys_dictionaries sd 
    WHERE sd.P_BM = tp.`PROJECT_TYPE`) PROJECT_TYPE_NAME 
  FROM
    tt_project_pact tp LEFT JOIN `tt_tribune` tt ON tp.`PROJECT_PACT_ID` =tt.`REVIEW_OBJ_ID` 
  WHERE tp.`IS_DEL` = 0 
    AND tp.`STRUCT_ID` = #{pd.structId}
    AND tp.`ITEM_ID` IS NULL
  AND (tt.`STATE`=2 OR tt.`STATE` IS NULL)
  ORDER BY tp.`CREATE_DATE` DESC) AS sa 
WHERE 1 = 1 

  <if test="pd.ITEMCOLLECTNAME != null and pd.ITEMCOLLECTNAME != ''">
  and (
  sa.`USER_NAME` LIKE #{pd.ITEMCOLLECTNAME2} 
  OR sa.`RECORD_NUMBER` LIKE #{pd.ITEMCOLLECTNAME2}
  OR sa.`PROJECT_NAME` LIKE #{pd.ITEMCOLLECTNAME2}
  OR sa.`BUILD_UNIT` LIKE #{pd.ITEMCOLLECTNAME2}
  OR sa. PROJECT_MANAGER_NAME LIKE #{pd.ITEMCOLLECTNAME2}
  )
  </if>
</select> 

<!-- 集团公司合同管理人 查看所有 -->
<select id="listPageAllIsPactManager" parameterType="page" resultType="pd">
SELECT 
  sa.* 
FROM
  (SELECT 
  tp.*,
  (SELECT 
    tt.`ITEM_NAME` 
  FROM
    tt_iteminfo tt 
  WHERE tt.`ITEM_ID` = tp.`ITEM_ID`) ITEM_NAME,
  u.`NAME` AS CREATE_NAME,
  (SELECT 
    NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tp.`USER_ID`) USER_NAME,
  TIMESTAMPDIFF(DAY, START_DATE, END_DATE) AS DAYS,
  (SELECT 
    su.NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tp.`PROJECT_MANAGER`) PROJECT_MANAGER_NAME,
  (SELECT 
    sd.NAME 
  FROM
    sys_dictionaries sd 
  WHERE sd.P_BM = tp.`PROJECT_TYPE`) PROJECT_TYPE_NAME,
  CASE
    (SELECT 
      STRUCTST_AGE 
    FROM
      sys_structinfo ss 
    WHERE ss.STRUCT_ID = tp.`STRUCT_ID`) 
    WHEN 0 
    THEN 'no' 
    ELSE 'yes' 
  END isReview,
  (SELECT 
    tt.STATE 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) reviewState,
  (SELECT 
    TRIBUNE_ID 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) TRIBUNE_ID  
FROM
  tt_project_pact tp,
  sys_user u 
WHERE tp.`IS_DEL` = 0 
	AND u.`USER_ID` = tp.`CREATE_BY`
  ORDER BY tp.`CREATE_DATE` DESC) AS sa 
WHERE 1 = 1 
 <if test="pd.PROVINCE !=null and pd.PROVINCE != '' ">
	AND sa.PROVINCE=#{pd.PROVINCE}
   </if>
   
   <if test="pd.STATMONEY !=null and pd.STATMONEY != '' ">
		AND   sa.MONEY &gt;=#{pd.STATMONEY}
     </if>
     <if test="pd.ENDMONEY !=null and pd.ENDMONEY != '' ">
		AND   sa.MONEY &lt;=#{pd.ENDMONEY}
     </if>
     
        <if test="pd.STATAREA !=null  and pd.STATAREA != '' ">
		AND   sa.AREA &gt;=#{pd.STATAREA}
     </if>
     <if test="pd.ENDAREA !=null  and pd.ENDAREA != ''">
		AND   sa.AREA &lt;=#{pd.ENDAREA}
     </if>
     <if test="pd.PROJECTTYPE !=null and pd.PROJECTTYPE != ''">
		AND   sa.PROJECT_TYPE =#{pd.PROJECTTYPE}
     </if>
      <if test="pd.STATE !=null and pd.STATE != ''">
		AND   sa.STATE =#{pd.STATE}
     </if>

  <if test="pd.ITEMCOLLECTNAME != null and pd.ITEMCOLLECTNAME != ''">
  and (
  sa.`USER_NAME` LIKE #{pd.ITEMCOLLECTNAME2} 
  OR sa.`RECORD_NUMBER` LIKE #{pd.ITEMCOLLECTNAME2}
  OR sa.`PROJECT_NAME` LIKE #{pd.ITEMCOLLECTNAME2}
  OR sa.`BUILD_UNIT` LIKE #{pd.ITEMCOLLECTNAME2}
  OR sa. PROJECT_MANAGER_NAME LIKE #{pd.ITEMCOLLECTNAME2}
  )
  </if>
<if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
  AND(
  (sa.`CREATE_DATE`  &gt;=#{pd.LASTLOGINSTART1} AND sa.`CREATE_DATE` &lt;=#{pd.LASTLOGINSTART2})
  )
  </if>
</if>

</select>


<!-- tab 切换 和 表格导出 -->
<select id="toExcelList" parameterType="pd" resultType="pd">
SELECT 
  sa.* 
FROM
  (SELECT 
  tpi.*,tp.COLOR,
    (SELECT 
      tt.`ITEM_NAME` 
    FROM
      tt_iteminfo tt 
    WHERE tt.`ITEM_ID` = tp.`ITEM_ID`) ITEM_NAME,
    u.`NAME` AS CREATE_NAME,
    (SELECT 
      NAME 
    FROM
      sys_user su 
    WHERE su.USER_ID = tp.`USER_ID`) USER_NAME,
    TIMESTAMPDIFF(DAY, tpi.START_DATE, tpi.END_DATE) AS DAYS,
    (SELECT 
      su.NAME 
    FROM
      sys_user su 
    WHERE su.USER_ID = tpi.`PROJECT_MANAGER`) PROJECT_MANAGER_NAME,
    (SELECT 
      GROUP_CONCAT(sd.NAME) 
    FROM
      sys_dictionaries sd 
    WHERE FIND_IN_SET(sd.BIANMA, tpi.`PACT_NATURE`)) PACT_NATURE_NAME,
    (SELECT 
      sd.NAME 
    FROM
      sys_dictionaries sd 
    WHERE sd.P_BM = tpi.`PROJECT_TYPE`) PROJECT_TYPE_NAME,
    CASE
      (SELECT 
        STRUCTST_AGE 
      FROM
        sys_structinfo ss 
      WHERE ss.STRUCT_ID = tp.`STRUCT_ID`) 
      WHEN 0 
      THEN 'no' 
      ELSE 'yes' 
    END isReview,
    (SELECT 
      tt.STATE 
    FROM
      tt_tribune tt 
    WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) reviewState,
    (SELECT 
      TRIBUNE_ID 
    FROM
      tt_tribune tt 
    WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) TRIBUNE_ID,
    (SELECT 
      STRUCT_NAME 
    FROM
      sys_structinfo s 
    WHERE s.STRUCT_ID = tp.STRUCT_ID) STRUCT_NAME,
    (SELECT 
      sd.NAME 
    FROM
      sys_dictionaries sd 
    WHERE sd.BIANMA = tpi.`PROVINCE`) PROVINCE_NAME,
    (SELECT 
      sd.NAME 
    FROM
      sys_dictionaries sd 
    WHERE sd.BIANMA = tpi.`CITY`) CITY_NAME,
    (SELECT 
      sd.NAME 
    FROM
      sys_dictionaries sd 
    WHERE sd.BIANMA = tpi.`STRUCTURE_TYPE`) STRUCTURE_TYPE_NAME 
  FROM
    tt_project_pact tp LEFT JOIN tt_project_inside_pact tpi ON tp.PROJECT_PACT_ID = tpi.PROJECT_PACT_ID,
    sys_user u  
WHERE tp.`IS_DEL` = 0 
and tp.PARENT_ID is  null
  AND u.`USER_ID` = tp.`CREATE_BY`
<if test="age== 'no'">
	AND tp.STRUCT_ID=#{structId}
</if>

<if test="selColor !=null and selColor != '' ">
	AND tp.COLOR=#{selColor}
</if>

<if test="dSCengCi != null and dSCengCi !='' ">
	AND tp.OVERGROUND  like  CONCAT(CONCAT('%', #{dSCengCi}),'%')
</if>

<if test="dXCengCi != null and dXCengCi !='' ">
	AND tp.UNDERGROUND like  CONCAT(CONCAT('%', #{dXCengCi}),'%') 
</if>

<if test="AREA != null and AREA !='' ">
	AND tp.AREA like  CONCAT(CONCAT('%', #{AREA}),'%') 
</if>

<if test="NOTIFY_DATE == 'isNull' ">
	AND (tp.`NOTIFY_DATE` IS NULL OR tp.`NOTIFY_DATE` ='')
</if>
<if test="certifiState !=null and certifiState != '' ">
	AND  tp.LOAN_STATE=#{certifiState}
</if>
<if test="CHECK_DATE == 'isNull' ">
	AND (tp.`CHECK_DATE` IS NULL OR tp.`CHECK_DATE` ='')
</if>
<if test="NOTIFY_DATE == 'has' ">
	AND (tp.`NOTIFY_DATE` IS NOT NULL AND tp.`NOTIFY_DATE` !='')
</if>
<if test="CHECK_DATE == 'has' ">
	AND (tp.`CHECK_DATE` IS NOT NULL AND tp.`CHECK_DATE` !='')
</if>   
  ORDER BY tp.`RECORD_NUMBER`,tp.`CREATE_DATE` DESC) AS sa 
WHERE 1 = 1 

<if test="PROVINCE !=null and PROVINCE != '' ">
	AND sa.PROVINCE=#{PROVINCE}
</if>
   
<if test="STATMONEY !=null and STATMONEY != '' ">
	AND   sa.MONEY &gt;=#{STATMONEY}
</if>
<if test="ENDMONEY !=null and ENDMONEY != '' ">
	AND   sa.MONEY &lt;=#{ENDMONEY}
</if>
<if test="STAT_STRUCTURE !=null and STAT_STRUCTURE != '' ">
AND   sa.STRUCTURE &gt;=#{STAT_STRUCTURE}
</if>
<if test="END_STRUCTURE !=null and END_STRUCTURE != '' ">
AND   sa.STRUCTURE &lt;=#{END_STRUCTURE}
</if>
 <if test="ENDAREA !=null  and ENDAREA != ''">
	AND   sa.AREA &lt;=#{ENDAREA}
</if>
<if test="PROJECTTYPE !=null and PROJECTTYPE != ''">
	AND   sa.PROJECT_TYPE =#{PROJECTTYPE}
</if>
<if test="STATE_TYPE !=null and STATE_TYPE != '' and STATE_TYPE != 'ss'">
	AND   sa.STATE =#{STATE_TYPE}
</if>
<if test="STRUCTID !=null and STRUCTID != '' ">
	AND sa.STRUCT_ID=#{STRUCTID}
</if>   
<if test="PACTNATURE !=null and PACTNATURE != '' and PACTNATURE!='null'">
	 AND sa.`PACT_NATURE`   LIKE CONCAT('%',#{PACTNATURE}, '%')
</if>    

  <if test="ITEMCOLLECTNAME != null and ITEMCOLLECTNAME != ''">
  and (
  sa.`RECORD_NUMBER` LIKE #{ITEMCOLLECTNAME2}
  OR sa.`PROJECT_NAME` LIKE #{ITEMCOLLECTNAME2}
  OR sa.`BUILD_UNIT` LIKE #{ITEMCOLLECTNAME2}
  OR sa.`PRIZE_REMARK` LIKE #{ITEMCOLLECTNAME2}
  or  (SELECT s.`NAME` FROM `sys_user` s WHERE s.`USER_ID`=sa.`USER_ID`) LIKE CONCAT('%',#{ITEMCOLLECTNAME2}, '%')
  )
  </if>
<if test="lastLoginStart !=null and lastLoginStart != '' ">
	AND sa.`MAKE_DATE`  &gt;=#{lastLoginStart}
</if>
<if test="lastLoginEnd !=null and lastLoginEnd != '' ">
    AND sa.`MAKE_DATE` &lt;=#{lastLoginEnd}
</if>

<if test="checkDateStart !=null and checkDateStart != '' ">
	AND sa.`CHECK_DATE`  &gt;=#{checkDateStart}
</if>
<if test="checkDateEnd !=null and checkDateEnd != '' ">
 AND sa.`CHECK_DATE` &lt;=#{checkDateEnd}
</if>

</select>

<select id="toExcelBeianList" parameterType="pd" resultType="pd">
SELECT 
  tp.*,
   ttp.RECORD_NUMBER AS NUMBWE_NO,
  (SELECT STRUCT_NAME FROM sys_structinfo s WHERE s.STRUCT_ID= (SELECT tpp.`STRUCT_ID` FROM `tt_project_pact` tpp WHERE tpp.`PROJECT_PACT_ID`=tp.PROJECT_PACT_ID )) as STRUCT_NAME,
  u.`NAME` AS CREATE_NAME,
  (SELECT 
    NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tp.`USER_ID`) USER_NAME,
  TIMESTAMPDIFF(DAY, tp.START_DATE, tp.END_DATE) AS DAYS,
  (SELECT 
    su.NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tp.`PROJECT_MANAGER`) PROJECT_MANAGER_NAME,
  (SELECT 
    GROUP_CONCAT(sd.NAME) 
  FROM
    sys_dictionaries sd 
  WHERE FIND_IN_SET(sd.BIANMA, tp.`PACT_NATURE`)) PACT_NATURE_NAME,
  (SELECT 
    sd.NAME 
  FROM
    sys_dictionaries sd 
  WHERE sd.P_BM = tp.`PROJECT_TYPE`) PROJECT_TYPE_NAME,
  (SELECT 
    tt.STATE 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) reviewState,
  (SELECT 
    TRIBUNE_ID 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) TRIBUNE_ID,
  (SELECT sd.NAME FROM sys_dictionaries sd WHERE sd.BIANMA = tp.`PROVINCE`) PROVINCE_NAME,
  (SELECT sd.NAME FROM sys_dictionaries sd WHERE sd.BIANMA = tp.`CITY`) CITY_NAME,
  (SELECT sd.NAME FROM sys_dictionaries sd WHERE sd.BIANMA = tp.`STRUCTURE_TYPE`) STRUCTURE_TYPE_NAME
FROM
  `tt_project_inside_pact`  tp, sys_user u ,`tt_project_pact` ttp 
  WHERE
  tp.`IS_DEL` = 0 
  AND u.`USER_ID` = tp.`CREATE_BY`
  AND tp.`PROJECT_PACT_ID`=ttp.`PROJECT_PACT_ID`
  AND  FIND_IN_SET(ttp.`PROJECT_PACT_ID`,#{projectPactIdList})
  ORDER BY ttp.`RECORD_NUMBER`,ttp.`CREATE_DATE` DESC
</select>

<select id="pactNatureList" parameterType="pd" resultType="pd">
SELECT 
  t.`NAME`,
  t.`BIANMA` 
FROM
  sys_dictionaries t 
WHERE t.`P_BM` LIKE #{projectType} 
</select>

  <insert id="insertSelective" parameterType="pd" >
    insert into tt_project_pact
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="projectPactId != null" >
        PROJECT_PACT_ID,
      </if>
      <if test="structId != null" >
        STRUCT_ID,
      </if>
      <if test="itemId != null" >
        ITEM_ID,
      </if>
      <if test="userId != null" >
        USER_ID,
      </if>
      <if test="recordNumber != null" >
        RECORD_NUMBER,
      </if>
      <if test="projectName != null" >
        PROJECT_NAME,
      </if>
      <if test="buildUnit != null" >
        BUILD_UNIT,
      </if>
      <if test="projectManager != null" >
        PROJECT_MANAGER,
      </if>
      <if test="actualDuty != null" >
        ACTUAL_DUTY,
      </if>
      <if test="money != null and money!=''" >
        MONEY,
      </if>
      <if test="area != null" >
        AREA,
      </if>
      <if test="structure != null  and structure !=''" >
        STRUCTURE,
      </if>
      <if test="projectType != null" >
        PROJECT_TYPE,
      </if>
      <if test="schedule != null" >
        SCHEDULE,
      </if>
      <if test="makeDate != null" >
        MAKE_DATE,
      </if>
      <if test="startDate != null" >
        START_DATE,
      </if>
      <if test="endDate != null" >
        END_DATE,
      </if>
      <if test="actualStartDate != null" >
        ACTUAL_START_DATE,
      </if>
      <if test="actualEndDate != null" >
        ACTUAL_END_DATE,
      </if>
      <if test="notifyDate != null" >
        NOTIFY_DATE,
      </if>
      <if test="checkDate != null" >
        CHECK_DATE,
      </if>
      <if test="prizeRemark != null" >
        PRIZE_REMARK,
      </if>
      <if test="bidDate != null" >
        BID_DATE,
      </if>
      <if test="bidMoney != null" >
        BID_MONEY,
      </if>
      <if test="pactNum != null" >
        PACT_NUM,
      </if>
      <if test="remark != null" >
        REMARK,
      </if>
      <if test="state != null" >
        STATE,
      </if>
      <if test="isDel != null" >
        IS_DEL,
      </if>
      <if test="createDate != null" >
        CREATE_DATE,
      </if>
      <if test="createBy != null" >
        CREATE_BY,
      </if>
      <if test="updateDate != null" >
        UPDATE_DATE,
      </if>
      <if test="updateBy != null" >
        UPDATE_BY,
      </if>
      
      <if test="province != null" >
        PROVINCE,
      </if>
      <if test="city != null" >
        CITY,
      </if>
      <if test="address != null" >
        ADDRESS,
      </if>
       <if test="isHistory != null" >
        IS_HISTORY,
      </if>
      <if test="pactNature !=null and pactNature!=''">
      PACT_NATURE,
      </if>
      <if test="loanState !=null">
      LOAN_STATE,
      </if>
        <if test="isFormal !=null">
      IS_FORMAL,
      </if>
         <if test="parentId !=null">
      PARENT_ID,
      </if>
      <if test="color !=null">
      COLOR,
      </if>
      
      <if test="overground !=null">
      OVERGROUND,
      </if>
      <if test="underground !=null">
      UNDERGROUND,
      </if>
      <if test="structureType !=null">
          STRUCTURE_TYPE,
      </if>
      <if test="zbColor !=null">
          ZB_COLOR,
      </if>
        <if test="jbColor !=null">
          JB_COLOR,
      </if>
      
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="projectPactId != null" >
        #{projectPactId,jdbcType=VARCHAR},
      </if>
      <if test="structId != null" >
        #{structId,jdbcType=VARCHAR},
      </if>
      <if test="itemId != null" >
        #{itemId,jdbcType=VARCHAR},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=VARCHAR},
      </if>
      <if test="recordNumber != null" >
        #{recordNumber,jdbcType=VARCHAR},
      </if>
      <if test="projectName != null" >
        #{projectName,jdbcType=VARCHAR},
      </if>
      <if test="buildUnit != null" >
        #{buildUnit,jdbcType=VARCHAR},
      </if>
      <if test="projectManager != null" >
        #{projectManager,jdbcType=VARCHAR},
      </if>
      <if test="actualDuty != null" >
        #{actualDuty,jdbcType=VARCHAR},
      </if>
      <if test="money != null" >
        #{money,jdbcType=DECIMAL},
      </if>
      <if test="area != null" >
        #{area,jdbcType=VARCHAR},
      </if>
      <if test="structure != null" >
        #{structure,jdbcType=DECIMAL},
      </if>
      <if test="projectType != null" >
        #{projectType,jdbcType=VARCHAR},
      </if>
      <if test="schedule != null" >
        #{schedule,jdbcType=VARCHAR},
      </if>
      <if test="makeDate != null" >
        #{makeDate,jdbcType=TIMESTAMP},
      </if>
      <if test="startDate != null" >
        #{startDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null" >
        #{endDate,jdbcType=TIMESTAMP},
      </if>
      <if test="actualStartDate != null" >
        #{actualStartDate,jdbcType=TIMESTAMP},
      </if>
      <if test="actualEndDate != null" >
        #{actualEndDate,jdbcType=TIMESTAMP},
      </if>
      <if test="notifyDate != null" >
        #{notifyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="checkDate != null" >
        #{checkDate,jdbcType=TIMESTAMP},
      </if>
      <if test="prizeRemark != null" >
        #{prizeRemark,jdbcType=VARCHAR},
      </if>
      <if test="bidDate != null" >
        #{bidDate,jdbcType=TIMESTAMP},
      </if>
      <if test="bidMoney != null" >
        #{bidMoney,jdbcType=DECIMAL},
      </if>
      <if test="pactNum != null" >
        #{pactNum,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="state != null" >
        #{state,jdbcType=INTEGER},
      </if>
      <if test="isDel != null" >
        #{isDel,jdbcType=INTEGER},
      </if>
      <if test="createDate != null" >
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createBy != null" >
        #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null" >
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateBy != null" >
        #{updateBy,jdbcType=VARCHAR},
      </if>
       <if test="province != null" >
       #{province,jdbcType=VARCHAR},
      </if>
      <if test="city != null" >
        #{city,jdbcType=VARCHAR},
      </if>
      <if test="address != null" >
        #{address,jdbcType=VARCHAR},
      </if>
      <if test="isHistory != null" >
       #{isHistory},
      </if>
      <if test="pactNature !=null and pactNature!=''">
         #{pactNature,jdbcType=VARCHAR},
      </if>
       <if test="loanState !=null">
      #{loanState,jdbcType=INTEGER},
      </if>
       <if test="isFormal !=null">
       #{isFormal},
      </if>
       <if test="parentId !=null">
       #{parentId},
      </if>
       <if test="color !=null">
      	#{color},
      </if>
      
       <if test="overground !=null">
      #{overground},
      </if>
      <if test="underground !=null">
     #{underground},
      </if>
      <if test="structureType !=null">
      #{structureType,jdbcType=VARCHAR},
      </if>
      
       <if test="zbColor !=null">
          #{zbColor},
      </if>
        <if test="jbColor !=null">
          #{jbColor},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="pd" >
    update tt_project_pact
    <set >
      <if test="itemId != null" >
        ITEM_ID = #{itemId,jdbcType=VARCHAR},
      </if>
      <if test="structId != null" >
        STRUCT_ID = #{structId,jdbcType=VARCHAR},
      </if>
      <if test="userId != null" >
        USER_ID = #{userId,jdbcType=VARCHAR},
      </if>
      <if test="recordNumber != null" >
        RECORD_NUMBER = #{recordNumber,jdbcType=VARCHAR},
      </if>
      <if test="projectName != null" >
        PROJECT_NAME = #{projectName,jdbcType=VARCHAR},
      </if>
      <if test="buildUnit != null" >
        BUILD_UNIT = #{buildUnit,jdbcType=VARCHAR},
      </if>
      <if test="projectManager != null" >
        PROJECT_MANAGER = #{projectManager,jdbcType=VARCHAR},
      </if>
      <if test="actualDuty != null" >
        ACTUAL_DUTY = #{actualDuty,jdbcType=VARCHAR},
      </if>
      <if test="money != null" >
        MONEY = #{money,jdbcType=DECIMAL},
      </if>
      <if test="area != null" >
        AREA = #{area,jdbcType=VARCHAR},
      </if>
      <if test="structure != null" >
        STRUCTURE = #{structure,jdbcType=DECIMAL},
      </if>
      <if test="projectType != null" >
        PROJECT_TYPE = #{projectType,jdbcType=VARCHAR},
      </if>
      <if test="schedule != null" >
        SCHEDULE = #{schedule,jdbcType=VARCHAR},
      </if>
      <if test="makeDate != null" >
        MAKE_DATE = #{makeDate,jdbcType=TIMESTAMP},
      </if>
      <if test="startDate != null" >
        START_DATE = #{startDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null" >
        END_DATE = #{endDate,jdbcType=TIMESTAMP},
      </if>
      <if test="actualStartDate != null" >
        ACTUAL_START_DATE = #{actualStartDate,jdbcType=TIMESTAMP},
      </if>
      <if test="actualEndDate != null" >
        ACTUAL_END_DATE = #{actualEndDate,jdbcType=TIMESTAMP},
      </if>
      <if test="notifyDate != null" >
        NOTIFY_DATE = #{notifyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="checkDate != null" >
        CHECK_DATE = #{checkDate,jdbcType=TIMESTAMP},
      </if>
      <if test="prizeRemark != null" >
        PRIZE_REMARK = #{prizeRemark,jdbcType=VARCHAR},
      </if>
      <if test="bidDate != null" >
        BID_DATE = #{bidDate,jdbcType=TIMESTAMP},
      </if>
      <if test="bidMoney != null" >
        BID_MONEY = #{bidMoney,jdbcType=DECIMAL},
      </if>
      <if test="pactNum != null" >
        PACT_NUM = #{pactNum,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        REMARK = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="state != null" >
        STATE = #{state,jdbcType=INTEGER},
      </if>
      <if test="isDel != null" >
        IS_DEL = #{isDel,jdbcType=INTEGER},
      </if>
      <if test="createDate != null" >
        CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createBy != null" >
        CREATE_BY = #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null" >
        UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateBy != null" >
        UPDATE_BY = #{updateBy,jdbcType=VARCHAR},
      </if>
       <if test="province != null" >
       PROVINCE=#{province,jdbcType=VARCHAR},
      </if>
      <if test="city != null" >
       CITY= #{city,jdbcType=VARCHAR},
      </if>
      <if test="address != null" >
       ADDRESS=#{address,jdbcType=VARCHAR},
      </if>
      <if test="pactNature !=null and pactNature!=''">
       PACT_NATURE = #{pactNature,jdbcType=VARCHAR},
      </if>
       <if test="isFormal !=null and isFormal!=''">
       IS_FORMAL = #{isFormal},
      </if>
      
      <if test="overground !=null and overground!=''">
       OVERGROUND = #{overground},
      </if>
      <if test="underground !=null and underground!=''">
       UNDERGROUND = #{underground},
      </if>
      <if test="structureType !=null">
       STRUCTURE_TYPE = #{structureType},
      </if>
    </set>
    where PROJECT_PACT_ID = #{projectPactId,jdbcType=VARCHAR}
  </update>
  
  
  <update id="updateForDate" parameterType="pd" >
    update tt_project_inside_pact
    <set >
    
      <if test="makeDate != null and makeDate ==''" >
        MAKE_DATE = NULL,
      </if>
      <if test="notifyDate != null and notifyDate ==''" >
        NOTIFY_DATE = NULL,
      </if>
      <if test="checkDate != null and checkDate ==''" >
        CHECK_DATE = NULL,
      </if>
      
      <if test="makeDate != null and makeDate !=''" >
        MAKE_DATE = #{makeDate,jdbcType=TIMESTAMP},
      </if>
      <if test="notifyDate != null and notifyDate !=''" >
        NOTIFY_DATE = #{notifyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="checkDate != null and checkDate !=''" >
        CHECK_DATE = #{checkDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where PROJECT_PACT_ID = #{projectPactId,jdbcType=VARCHAR}
  </update>
  
  
  
  
  
<!-- 辅合同查询 -->
<select id="findFuPactlistPage" parameterType="page" resultType="pd">
SELECT 
  sa.* 
FROM
  (SELECT 
    PROJECT_PACT_ID, ITEM_ID, USER_ID, RECORD_NUMBER, PROJECT_NAME, BUILD_UNIT, PROJECT_MANAGER, STRUCT_ID,
    ACTUAL_DUTY, MONEY, AREA, STRUCTURE, PROJECT_TYPE, SCHEDULE, MAKE_DATE, START_DATE, 
    END_DATE, ACTUAL_START_DATE, ACTUAL_END_DATE, NOTIFY_DATE, CHECK_DATE, PRIZE_REMARK, 
    BID_DATE, BID_MONEY, PACT_NUM, REMARK, STATE, IS_DEL, CREATE_DATE, CREATE_BY, UPDATE_DATE,PACT_NATURE 
    UPDATE_BY,PROVINCE,CITY,ADDRESS,LOAN_STATE,IS_HISTORY,
  (SELECT 
    tt.`ITEM_NAME` 
  FROM
    tt_iteminfo tt 
  WHERE tt.`ITEM_ID` = tp.`ITEM_ID`) ITEM_NAME,
  (SELECT 
    NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tp.`CREATE_BY`) AS CREATE_NAME,
  (SELECT 
    NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tp.`USER_ID`) USER_NAME,
  TIMESTAMPDIFF(DAY, START_DATE, END_DATE) AS DAYS,
  (SELECT 
    su.NAME 
  FROM
    sys_user su 
  WHERE su.USER_ID = tp.`PROJECT_MANAGER`) PROJECT_MANAGER_NAME,
  (SELECT 
    sd.NAME 
  FROM
    sys_dictionaries sd 
  WHERE sd.P_BM = tp.`PROJECT_TYPE`) PROJECT_TYPE_NAME,
  CASE
    (SELECT COUNT(*)
      FROM tt_tribune tr WHERE tr.REVIEW_OBJ_ID =tp.PROJECT_PACT_ID ) 
    WHEN 0 
    THEN 'no' 
    ELSE 'yes' 
  END isReview,
  (SELECT 
    tt.STATE 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) reviewState,
  (SELECT 
    TRIBUNE_ID 
  FROM
    tt_tribune tt 
  WHERE tt.REVIEW_OBJ_ID = tp.PROJECT_PACT_ID) TRIBUNE_ID,
  (SELECT STRUCT_NAME FROM sys_structinfo s WHERE s.STRUCT_ID = tp.STRUCT_ID)  STRUCT_NAME 
FROM
  tt_project_pact tp
WHERE tp.`IS_DEL` = 0 
  and tp.PARENT_ID=#{pd.projectPactId}
  ORDER BY tp.RECORD_NUMBER,tp.`CREATE_DATE` DESC) AS sa 
WHERE 1 = 1 

  <if test="pd.NAME != null and pd.NAME != ''">
  and (
   sa.`RECORD_NUMBER` LIKE CONCAT('%',#{pd.NAME}, '%')
  OR sa.`PROJECT_NAME` LIKE CONCAT('%',#{pd.NAME}, '%')
  OR sa.`BUILD_UNIT` LIKE CONCAT('%',#{pd.NAME}, '%')
  OR sa. PROJECT_MANAGER_NAME LIKE CONCAT('%',#{pd.NAME}, '%') 
  )
  </if>

ORDER BY sa.RECORD_NUMBER,sa.`CREATE_DATE` DESC
</select>   
  <!--  月报表-->
  <select id="findItemExcelAndMonth" parameterType="pd" resultType="pd">
SELECT 
  (SELECT s.`STRUCT_NAME` FROM `sys_structinfo` s WHERE s.`STRUCT_ID`=tp.`STRUCT_ID`) AS STRUCT_NAME,
  p.`PROJECT_NAME`,
  p.BUILD_UNIT,
  p.MONEY,
  p.STRUCTURE,
  p.AREA,
  p.BID_MONEY,
   DATE_FORMAT(p.START_DATE,'%Y-%m-%d') AS START_DATE ,
   DATE_FORMAT(p.END_DATE,'%Y-%m-%d') AS END_DATE,
   DATEDIFF(DATE_FORMAT(p.END_DATE,'%Y-%m-%d'), DATE_FORMAT(p.START_DATE,'%Y-%m-%d')) AS DAY,
   DATE_FORMAT(p.ACTUAL_START_DATE,'%Y-%m-%d') AS ACTUAL_START_DATE,
   DATE_FORMAT(p.ACTUAL_END_DATE,'%Y-%m-%d') AS ACTUAL_END_DATE,
  (SELECT GROUP_CONCAT(d.`NAME`) FROM `sys_dictionaries` d WHERE FIND_IN_SET(d.`BIANMA`,p.PACT_NATURE)) AS PACT_NATURE,
 (SELECT u.`NAME` FROM `sys_user` u WHERE u.`USER_ID`= p.PROJECT_MANAGER) AS PROJECT_MANAGER,
 DATE_FORMAT(p.MAKE_DATE,'%Y-%m-%d') AS MAKE_DATE,
 CASE
    WHEN p.STATE = 0 
    THEN '待建' 
    WHEN p.STATE = 1 
    THEN '在建' 
    WHEN p.STATE = 2 
    THEN '暂停' 
    WHEN p.STATE = 3 
    THEN '完工' 
    WHEN p.STATE = 4 
    THEN '竣工' 
  END AS STATE,
 p.PRIZE_REMARK
FROM
  `tt_project_inside_pact` p 
  LEFT JOIN `tt_project_pact` tp 
    ON p.`PROJECT_PACT_ID` = tp.`PROJECT_PACT_ID` 
WHERE  1=1  and p.STATE&lt;4
<if test="year!=null and year !='' ">
  and 	DATE_FORMAT(p.MAKE_DATE, '%Y') = #{year}
</if>
<if test="year==null or year =='' ">
	and DATE_FORMAT(p.MAKE_DATE, '%Y-%m') = #{startMonth}
</if>
ORDER BY tp.STRUCT_ID  DESC 
  </select>  
  
  
  
  <select id="findItemExcelAndChanzhi" parameterType="pd" resultType="pd">


SELECT 
  (SELECT 
    s.`STRUCT_NAME` 
  FROM
    `sys_structinfo` s 
  WHERE s.`STRUCT_ID` = i.`STRUCT_ID`) AS STRUCT_NAME,
  p.`PROJECT_NAME`,
  p.MONEY,
  (SELECT 
    SUM(ic.`COLLECT_MONEY`) 
  FROM
    tt_item_collect ic 
  WHERE ic.`ITEM_ID` = i.`ITEM_ID` 
  
  <if test="year!=null and year !='' ">
  and 	DATE_FORMAT(ic.COLLECT_DATE, '%Y') = #{year}
</if>
<if test="year==null or year =='' ">
	AND DATE_FORMAT(ic.COLLECT_DATE, '%Y-%m') = #{startMonth}
</if>
    
     
    AND ic.IS_DEL = 0) AS collmoney,
  (SELECT 
    SUM(o.`TAX_MONEY`) 
  FROM
    tt_output_invoice o,
    tt_bill_apply b 
  WHERE o.`IS_DEL` = 0 
    AND o.`BILL_APPLY_ID` = b.`BILL_APPLY_ID` 
    AND b.`ITEM_ID` = i.`ITEM_ID` 
   
     <if test="year!=null and year !='' ">
  and 	DATE_FORMAT(o.TAX_DATE, '%Y') = #{year}
</if>
<if test="year==null or year =='' ">
	 AND DATE_FORMAT(o.TAX_DATE, '%Y-%m') =#{startMonth}
</if>
    
    
    ) AS TAX_MONEY,
  (SELECT 
    SUM(OUTVALUE_MONEY) 
  FROM
    tt_item_outvalue io 
  WHERE io.item_id = i.`ITEM_ID` 
    AND io.IS_DEL = 0 
   
    
       <if test="year!=null and year !='' ">
  and 	SUBSTRING(OUTVALUE_DATE,1,4)=#{year}
</if>
<if test="year==null or year =='' ">
	 AND io.OUTVALUE_DATE = #{startMonth}
</if>
    
    ) AS OUTVALUE_MONEY,
  (SELECT 
    SUM(BILLING_MONEY) 
  FROM
    tt_item_billing ib 
  WHERE ib.item_id = i.`ITEM_ID` 
    AND ib.IS_DEL = 0 
    
    <if test="year!=null and year !='' ">
  and 	DATE_FORMAT(ib.BILLING_DATE, '%Y') = #{year}
</if>
<if test="year==null or year =='' ">
	 AND DATE_FORMAT(ib.BILLING_DATE, '%Y-%m') = #{startMonth}
</if>
    
    
    
    ) AS BILLING_MONEY 
FROM
  `tt_iteminfo` i 
  LEFT JOIN `tt_project_pact` p 
    ON i.`ITEM_ID` = p.`ITEM_ID` 
WHERE p.`STATE`  &lt; 4 
  AND i.`IS_DEL` = 0 
  ORDER BY i.STRUCT_ID  DESC 
   </select>  
  
  <update id="updateColor" parameterType="pd">
UPDATE 
  tt_project_pact t 
SET
 
  <if test="typeColor=='COLOR'">
	 t.COLOR=#{COLOR}
  </if>
  <if test="typeColor=='ZB_COLOR'">
	 t.ZB_COLOR=#{COLOR}
  </if>
  <if test="typeColor=='JB_COLOR'">
	 t.JB_COLOR=#{COLOR}
  </if>
WHERE t.`PROJECT_PACT_ID` = #{PROJECT_PACT_ID} 
</update>
 
<select id="structureTypes" parameterType="pd" resultType="pd">
SELECT 
  sd.NAME,
  sd.`BIANMA` 
FROM
  sys_dictionaries sd 
WHERE sd.`P_BM` LIKE 'JGLX_%' 
</select>  
<!-- 修改备案合同  is_del = 1-->
<update id="deleteBeiAn" parameterType="pd" >
UPDATE tt_project_inside_pact t 
  SET t.`IS_DEL`= 1,
  t.UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
  t.UPDATE_BY = #{updateBy,jdbcType=VARCHAR} 
  WHERE t.`PROJECT_PACT_ID`= #{projectPactId,jdbcType=VARCHAR}
</update>


  
</mapper>