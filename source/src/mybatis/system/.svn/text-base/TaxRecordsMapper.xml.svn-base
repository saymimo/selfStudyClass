<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="TaxRecordsMapper" >
<select id="findInfoToTree" parameterType="pd"  resultType="com.ssc.entity.system.TreeList" >
	 
SELECT struct_id AS id,struct_name AS text,'0' AS parentId,'STRUCT' AS level FROM `sys_structinfo` WHERE structst_age=0 
UNION
SELECT struct_id AS id,struct_name AS text,(SELECT struct_id FROM `sys_structinfo` WHERE structst_age=0 ) AS parentId,'STRUCT' AS level FROM sys_structinfo WHERE structst_age !=0
UNION
SELECT item_id AS id,item_name AS text,tt_iteminfo.struct_id AS parentId, 'ITEM' AS level  FROM tt_iteminfo LEFT JOIN sys_structinfo ON sys_structinfo.`STRUCT_ID`=tt_iteminfo.`STRUCT_ID`
		
</select>  

<select id="structList"  resultType="pd">
SELECT 
  t.`STRUCT_ID`,
  t.`STRUCT_NAME` 
FROM
  sys_structinfo t 
WHERE t.`IS_DEL` = 0 
</select>

<select id="listPageAllExchangeforItem" parameterType="page" resultType="pd">
SELECT sa.*,
(IFNULL(IN_INVOICE_MONEY_1,0) + IFNULL(ADJUST_TAX_0,0)) TAX_RETAINED,
(IFNULL(OUT_INVOICE_MONEY,0) - IFNULL(OUT_TAX_MONEY,0)) OUT_SALES_MONEY,
 (
 SELECT SUM(tii.`TAX_MONEY`) FROM tt_in_invoice tii WHERE tii.`IN_INVOICE_ID` IN
(
 SELECT tip.`IN_INVOICE_ID` FROM tt_invoice_plan tip   WHERE tip.`ITEM_ID` = sa.ITEM_ID
 <if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
 AND ( tip.`CREATE_BY` >= #{pd.LASTLOGINSTART1}  AND #{pd.LASTLOGINSTART2} >=tip.`CREATE_DATE`)
 </if>
</if>
 )
 ) MANAGER_SWAP
FROM (
SELECT 
 t.ITEM_ID,
(SELECT ti.ITEM_NAME FROM tt_iteminfo ti WHERE ti.ITEM_ID = t.`ITEM_ID`) ITEM_NAME,
SUM((SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID =t.`BILL_APPLY_ID`)) OUT_INVOICE_MONEY,
SUM((SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID =t.`BILL_APPLY_ID`)) OUT_TAX_MONEY,
SUM((SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE tpt.IS_DEL=0 AND tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tpt.RATE_MONEY =2)) PAY_TAX_MONEY_2,
SUM((SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE tpt.IS_DEL=0 AND tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tpt.RATE_MONEY =3)) PAY_TAX_MONEY_3,
SUM((
SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii WHERE tii.IN_INVOICE_ID IN 
((SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE = 0))
)) PACT_MONEY ,
SUM((
 SELECT SUM(tit.D_MONEY) FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND (tit.IS_SUBPACKAGE=1 or tit.IS_SUBPACKAGE=0)
)) IN_INVOICE_MONEY_3,
(
 SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.`ITEM_ID` AND tii.IS_DEL=0 AND tii.STATE=1 
) IN_INVOICE_MONEY_1,
(
 SELECT SUM(tio.TAX_MONEY) FROM tt_invoice_out tio WHERE tio.IN_INVOICE_ID IN 
 (SELECT tii.IN_INVOICE_ID FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.`ITEM_ID` AND tii.IS_DEL=0 )
<if test="pd.LASTLOGINSTART1 ==null or pd.LASTLOGINSTART1 == '' ">
  <if test="pd.LASTLOGINSTART2 ==null or pd.LASTLOGINSTART2 == '' ">
 AND (
      tio.CREATE_DATE >=DATE_FORMAT(NOW(), '%Y-%m-01') AND LAST_DAY(NOW())>tio.CREATE_DATE
      )
 </if>
</if>
<if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
      AND (
        tio.CREATE_DATE >= #{pd.LASTLOGINSTART1}
        AND  #{pd.LASTLOGINSTART2}  >= tio.CREATE_DATE
      ) 
  </if>
</if>
) IN_OUT_MONEY,
SUM((
  SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.TAX_ADJUSTMENT_ID IN 
  (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE =2 )
  AND tta.DK_STATE =1
 )) ADJUST_TAX_1,
 (
 	SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.APPLY_ITEM =t.`ITEM_ID` AND tta.IS_DEL =0 AND tta.DK_STATE = 0 AND tta.STATE=1
<if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
      AND (
        tta.APPROVAL_DATE >= #{pd.LASTLOGINSTART1}
        AND  #{pd.LASTLOGINSTART2}  >= tta.APPROVAL_DATE
      ) 
  </if>
</if>
 ) ADJUST_TAX_0,
 SUM((SELECT SUM(ttl.MONEY) FROM tt_taxation_list ttl WHERE ttl.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND ttl.STATE=1 AND ttl.IS_DEL=0 AND ttl.TYPE=8)) ADD_MONEY,
 SUM((SELECT SUM(tps.ADD_TAX_MONEY) FROM tt_pay_settlement tps WHERE tps.BILL_APPLY_ID =t.`BILL_APPLY_ID`)) ADD_TAX_MONEY
FROM
  tt_bill_apply t
WHERE t.`STRUCT_ID` = #{pd.STRUCT_ID} 
AND t.`IS_DEL`=0
<if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
      AND (
        t.CREATE_DATE >= #{pd.LASTLOGINSTART1}
        AND  #{pd.LASTLOGINSTART2}  >= t.CREATE_DATE
      ) 
  </if>
</if>
GROUP BY t.`ITEM_ID` 
)sa 
</select>

<!-- 查询公司 -->
<select id="listPageAllExchangeforStruct" parameterType="page" resultType="pd">
SELECT sa.*,
(IFNULL(IN_INVOICE_MONEY_1,0) + IFNULL(ADJUST_TAX_0,0)) TAX_RETAINED,
(IFNULL(OUT_INVOICE_MONEY,0) - IFNULL(OUT_TAX_MONEY,0)) OUT_SALES_MONEY,
 (
 SELECT SUM(tii.`TAX_MONEY`) FROM tt_in_invoice tii WHERE tii.`IN_INVOICE_ID` IN
(
 SELECT tip.`IN_INVOICE_ID` FROM tt_invoice_plan tip ,tt_iteminfo ti   WHERE tip.`ITEM_ID` = ti.`ITEM_ID` AND ti.`STRUCT_ID` = sa.STRUCT_ID
 <if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
 AND ( tip.`CREATE_BY` >= #{pd.LASTLOGINSTART1}  AND #{pd.LASTLOGINSTART2} >=tip.`CREATE_DATE`)
 </if>
</if>
 )
 ) MANAGER_SWAP
FROM (
SELECT 
 t.`STRUCT_ID`,
 (SELECT ss.STRUCT_NAME FROM sys_structinfo ss WHERE ss.STRUCT_ID = t.`STRUCT_ID`)STRUCT_NAME,
 SUM((SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID =t.`BILL_APPLY_ID`)) OUT_INVOICE_MONEY,
 SUM((SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID =t.`BILL_APPLY_ID`) )OUT_TAX_MONEY,
 SUM((SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE tpt.IS_DEL=0 AND tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tpt.RATE_MONEY =2)) PAY_TAX_MONEY_2,
 SUM((SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE tpt.IS_DEL=0 AND tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tpt.RATE_MONEY =3)) PAY_TAX_MONEY_3,
 SUM((
SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii WHERE tii.IN_INVOICE_ID IN 
((SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE = 0))
)) PACT_MONEY ,
SUM((
 SELECT SUM(tit.D_MONEY) FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND (tit.IS_SUBPACKAGE=1 or tit.IS_SUBPACKAGE=0)
)) IN_INVOICE_MONEY_3,
SUM((
 SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.`ITEM_ID` AND tii.IS_DEL=0 AND tii.STATE=1 
)) IN_INVOICE_MONEY_1,
SUM((
 SELECT SUM(tio.TAX_MONEY) FROM tt_invoice_out tio WHERE tio.IN_INVOICE_ID IN 
 (SELECT tii.IN_INVOICE_ID FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.`ITEM_ID` AND tii.IS_DEL=0 )
<if test="pd.LASTLOGINSTART1 ==null or pd.LASTLOGINSTART1 == '' ">
  <if test="pd.LASTLOGINSTART2 ==null or pd.LASTLOGINSTART2 == '' ">
 AND (
      tio.CREATE_DATE >=DATE_FORMAT(NOW(), '%Y-%m-01') AND LAST_DAY(NOW())>tio.CREATE_DATE
      )
 </if>
</if>
<if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
      AND (
        tio.CREATE_DATE >= #{pd.LASTLOGINSTART1}
        AND  #{pd.LASTLOGINSTART2}  >= tio.CREATE_DATE
      ) 
  </if>
</if>
)) IN_OUT_MONEY,
SUM((
  SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.TAX_ADJUSTMENT_ID IN 
  (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE =2 )
  AND tta.DK_STATE =1
 )) ADJUST_TAX_1,
 SUM((
 	SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.APPLY_ITEM =t.`ITEM_ID` AND tta.IS_DEL =0 AND tta.DK_STATE = 0 AND tta.STATE=1
<if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
      AND (
        tta.APPROVAL_DATE >= #{pd.LASTLOGINSTART1}
        AND  #{pd.LASTLOGINSTART2}  >= tta.APPROVAL_DATE
      ) 
  </if>
</if>
 )) ADJUST_TAX_0,
 SUM((SELECT SUM(ttl.MONEY) FROM tt_taxation_list ttl WHERE ttl.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND ttl.STATE=1 AND ttl.IS_DEL=0 AND ttl.TYPE=8)) ADD_MONEY,
 SUM((SELECT SUM(tps.ADD_TAX_MONEY) FROM tt_pay_settlement tps WHERE tps.BILL_APPLY_ID =t.`BILL_APPLY_ID`)) ADD_TAX_MONEY
FROM
  tt_bill_apply t 
WHERE t.`IS_DEL` = 0 
AND t.`STRUCT_ID`!= #{pd.structId}
<if test="pd.LASTLOGINSTART1 !=null and pd.LASTLOGINSTART1 != '' ">
  <if test="pd.LASTLOGINSTART2 !=null and pd.LASTLOGINSTART2 != '' ">
      AND (
        t.CREATE_DATE >= #{pd.LASTLOGINSTART1}
        AND  #{pd.LASTLOGINSTART2}  >= t.CREATE_DATE
      ) 
  </if>
</if>
GROUP BY t.`STRUCT_ID` 
)sa
</select>


<!-- 查子公司 -->
<select id="aObjForExchange" parameterType="pd" resultType="pd">
SELECT sa.*,
(IFNULL(IN_INVOICE_MONEY_1,0) + IFNULL(ADJUST_TAX_0,0)) TAX_RETAINED,
(IFNULL(OUT_INVOICE_MONEY,0) - IFNULL(OUT_TAX_MONEY,0)) OUT_SALES_MONEY,
#{structId,jdbcType=VARCHAR} STRUCT_ID,
 (SELECT ss.STRUCT_NAME FROM sys_structinfo ss WHERE ss.STRUCT_ID =#{structId,jdbcType=VARCHAR})STRUCT_NAME,
 (
 SELECT SUM(tii.`TAX_MONEY`) FROM tt_in_invoice tii WHERE tii.`IN_INVOICE_ID` IN
(
 SELECT tip.`IN_INVOICE_ID` FROM tt_invoice_plan tip ,tt_iteminfo ti   WHERE tip.`ITEM_ID` = ti.`ITEM_ID` AND ti.`STRUCT_ID` = #{structId,jdbcType=VARCHAR}
 <if test="LASTLOGINSTART1 !=null and LASTLOGINSTART1 != '' ">
  <if test="LASTLOGINSTART2 !=null and LASTLOGINSTART2 != '' ">
 AND ( tip.`CREATE_BY` >= #{LASTLOGINSTART1}  AND #{LASTLOGINSTART2} >=tip.`CREATE_DATE`)
 </if>
</if>
 )
 ) MANAGER_SWAP
FROM (
SELECT 
 SUM((SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID =t.`BILL_APPLY_ID`)) OUT_INVOICE_MONEY,
 SUM((SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID =t.`BILL_APPLY_ID`) )OUT_TAX_MONEY,
 SUM((SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE tpt.IS_DEL=0 AND tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tpt.RATE_MONEY =2)) PAY_TAX_MONEY_2,
 SUM((SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE tpt.IS_DEL=0 AND tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tpt.RATE_MONEY =3)) PAY_TAX_MONEY_3,
 SUM((
SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii WHERE tii.IN_INVOICE_ID IN 
((SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE = 0))
)) PACT_MONEY ,
SUM((
 SELECT SUM(tit.D_MONEY) FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND (tit.IS_SUBPACKAGE=1 or tit.IS_SUBPACKAGE=0)
)) IN_INVOICE_MONEY_3,
SUM((
 SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.`ITEM_ID` AND tii.IS_DEL=0 AND tii.STATE=1 
)) IN_INVOICE_MONEY_1,
SUM((
 SELECT SUM(tio.TAX_MONEY) FROM tt_invoice_out tio WHERE tio.IN_INVOICE_ID IN 
 (SELECT tii.IN_INVOICE_ID FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.`ITEM_ID` AND tii.IS_DEL=0 )
<if test="LASTLOGINSTART1 ==null or LASTLOGINSTART1 == '' ">
  <if test="LASTLOGINSTART2 ==null or LASTLOGINSTART2 == '' ">
 AND (
      tio.CREATE_DATE >=DATE_FORMAT(NOW(), '%Y-%m-01') AND LAST_DAY(NOW())>tio.CREATE_DATE
      )
 </if>
</if>
<if test="LASTLOGINSTART1 !=null and LASTLOGINSTART1 != '' ">
  <if test="LASTLOGINSTART2 !=null and LASTLOGINSTART2 != '' ">
      AND (
        tio.CREATE_DATE >= #{LASTLOGINSTART1}
        AND  #{LASTLOGINSTART2}  >= tio.CREATE_DATE
      ) 
  </if>
</if>
)) IN_OUT_MONEY,
SUM((
  SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.TAX_ADJUSTMENT_ID IN 
  (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE =2 )
  AND tta.DK_STATE =1
 )) ADJUST_TAX_1,
 SUM((
 	SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.APPLY_ITEM =t.`ITEM_ID` AND tta.IS_DEL =0 AND tta.DK_STATE = 0 AND tta.STATE=1
<if test="LASTLOGINSTART1 !=null and LASTLOGINSTART1 != '' ">
  <if test="LASTLOGINSTART2 !=null and LASTLOGINSTART2 != '' ">
      AND (
        tta.APPROVAL_DATE >= #{LASTLOGINSTART1}
        AND  #{LASTLOGINSTART2}  >= tta.APPROVAL_DATE
      ) 
  </if>
</if>
 )) ADJUST_TAX_0,
 SUM((SELECT SUM(ttl.MONEY) FROM tt_taxation_list ttl WHERE ttl.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND ttl.STATE=1 AND ttl.IS_DEL=0 AND ttl.TYPE=8)) ADD_MONEY,
 SUM((SELECT SUM(tps.ADD_TAX_MONEY) FROM tt_pay_settlement tps WHERE tps.BILL_APPLY_ID =t.`BILL_APPLY_ID`)) ADD_TAX_MONEY
FROM
  tt_bill_apply t 
WHERE t.`IS_DEL` = 0 
<if test="age == 'no' ">
 AND t.`STRUCT_ID` = #{structId,jdbcType=VARCHAR}
</if>
<if test="LASTLOGINSTART1 !=null and LASTLOGINSTART1 != '' ">
  <if test="LASTLOGINSTART2 !=null and LASTLOGINSTART2 != '' ">
      AND (
        t.CREATE_DATE >= #{LASTLOGINSTART1}
        AND  #{LASTLOGINSTART2}  >= t.CREATE_DATE
      ) 
  </if>
</if>
)sa
</select>



<select id="listTaxCollectionForStruct" parameterType="pd" resultType="pd">
SELECT 
   STRUCT_ID,
   (SELECT s.STRUCT_NAME FROM sys_structinfo s WHERE s.STRUCT_ID = a.STRUCT_ID) STRUCT_NAME,
   SUM(OUT_TAX_NO_INCLUDED_3 ) OUT_TAX_NO_INCLUDED_3,
   SUM(OUT_TAX_MONEY_3 )       OUT_TAX_MONEY_3,
   SUM(OUT_INVOICE_MONEY_3 )   OUT_INVOICE_MONEY_3, 
   SUM(OUT_TAX_NO_INCLUDED_11 ) OUT_TAX_NO_INCLUDED_11,
   SUM(OUT_TAX_MONEY_11 )       OUT_TAX_MONEY_11,
   SUM(OUT_INVOICE_MONEY_11 )   OUT_INVOICE_MONEY_11,
   SUM(PACT_MONEY_1 ) PACT_MONEY_1,
   SUM(PACT_MONEY_0 ) PACT_MONEY_0,
   SUM(ADD_TAX_MONEY  ) ADD_TAX_MONEY ,
   SUM(PAY_TAX_3 ) PAY_TAX_3,
   SUM(PAY_TAX_2 ) PAY_TAX_2,
   SUM(IN_OUT_TAX ) IN_OUT_TAX,
   SUM(IN_TAX_RZ ) IN_TAX_RZ,
   (
    SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID 
    WHERE tii.IS_DEL=0 AND tii.STATE>=1 AND ti.TAXATION_TYPE = 0 AND tii.STRUCT_ID = a.STRUCT_ID 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
   ) IN_TAX_MONEY,
   SUM((
   CASE 
     WHEN 0 > SETTLEMENT_TAX AND TAXATION_TYPE != 1
     THEN 0
     ELSE SETTLEMENT_TAX
    END 
    )) SETTLEMENT_TAX,
   SUM((
   CASE
    WHEN 0 >TAX_RETAINED
    THEN 0
    ELSE TAX_RETAINED
   END
   ))  TAX_RETAINED,
   SUM(IN_DECLARE_MONEY ) IN_DECLARE_MONEY
FROM (
SELECT 
  ch.*,
  ROUND((
  CASE
   WHEN TAXATION_TYPE = 1
   THEN 0 
   WHEN SETTLEMENT_TAX>0
   THEN 0
   ELSE IFNULL(IN_TAX_RZ,0) - IFNULL(ADD_TAX_MONEY,0) + IFNULL(PAY_TAX,0) - IFNULL(IN_OUT_TAX,0) - IFNULL(TAX_ADJUSTMENT,0)
  END 
  ),2) TAX_RETAINED,
  ROUND((
  CASE 
   WHEN TAXATION_TYPE = 1
   THEN 0
   WHEN SETTLEMENT_TAX>0
   THEN IN_TAX_RZ
   ELSE  IFNULL(ADD_TAX_MONEY,0) -  IFNULL(PAY_TAX,0) + IFNULL(IN_OUT_TAX,0) + IFNULL(TAX_ADJUSTMENT,0)
  END
  ),2) IN_DECLARE_MONEY
FROM(
SELECT 
  sa.*,
  ROUND(
     IFNULL(ADD_TAX_MONEY_0  * 0.11,0) +
     IFNULL( ((IFNULL(ADD_TAX_MONEY_1,0) - IFNULL(PACT_TAX_NO_MONEY_1,0) ) * 0.03),0)
   ,2) ADD_TAX_MONEY,
  ROUND(
     IFNULL(ADD_TAX_MONEY_0 * 0.11,0) +IFNULL( ((IFNULL(ADD_TAX_MONEY_1,0) - IFNULL(PACT_TAX_NO_MONEY_1,0) ) * 0.03),0) -
        IFNULL(PAY_TAX_3,0) -  IFNULL(PAY_TAX_2,0) -  IFNULL(IN_TAX,0) -  IFNULL(ESTATE_MONEY,0)  +  IFNULL(IN_OUT_TAX ,0)+  IFNULL(TAX_ADJUSTMENT,0)
   ,2) SETTLEMENT_TAX,
   IFNULL(PAY_TAX_3,0) +  IFNULL(PAY_TAX_2,0) PAY_TAX,
   IFNULL(IN_TAX,0) + IFNULL(ESTATE_MONEY,0) IN_TAX_RZ 
FROM (
SELECT 
  SUM((
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  ))OUT_TAX_NO_INCLUDED_3,
  SUM((
   SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_MONEY_3,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY + toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_INVOICE_MONEY_3,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_NO_INCLUDED_11,
  SUM((
   SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_MONEY_11,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY + toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_INVOICE_MONEY_11,
  (
    SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 1 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
  )PACT_MONEY_1,
  (
    SELECT SUM(tii.TAX_NO_INCLUDED) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 1 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>    
  )PACT_TAX_NO_MONEY_1,
  (
    SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 0 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
  )PACT_MONEY_0,
  (
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi LEFT JOIN tt_iteminfo ti ON toi.ITEM_ID = ti.ITEM_ID WHERE toi.IS_DEL = 0 AND toi.BILL_APPLY_ID IS NOT NULL AND toi.BILL_APPLY_ID !=''  
   AND ti.TAXATION_TYPE =0 AND toi.ITEM_ID = t.`ITEM_ID`
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )ADD_TAX_MONEY_0,
  (
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi LEFT JOIN tt_iteminfo ti ON toi.ITEM_ID = ti.ITEM_ID WHERE toi.IS_DEL = 0 AND toi.BILL_APPLY_ID IS NOT NULL AND toi.BILL_APPLY_ID !=''  
   AND ti.TAXATION_TYPE =1 AND toi.ITEM_ID = t.`ITEM_ID`
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )ADD_TAX_MONEY_1,
  SUM((
   SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE t.`BILL_APPLY_ID` = tpt.BILL_APPLY_ID AND tpt.IS_DEL=0 AND (tpt.RATE_MONEY =2 OR tpt.RATE_MONEY =11) 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tpt.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tpt.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tpt.CREATE_DATE
</if>
   )) PAY_TAX_2,
  SUM((
   SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE t.`BILL_APPLY_ID` = tpt.BILL_APPLY_ID AND tpt.IS_DEL=0 AND tpt.RATE_MONEY =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tpt.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tpt.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tpt.CREATE_DATE
</if>   
   )) PAY_TAX_3,
  (
   SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID WHERE tii.IS_DEL=0 
   AND ti.TAXATION_TYPE =0 AND tii.IN_STATE =0 AND tii.ITEM_ID = t.`ITEM_ID` AND tii.STATE>=1 AND  tii.IS_ESTATE = 0
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>  
  )IN_TAX,
  (
   SELECT SUM(tio.TAX_MONEY) FROM tt_invoice_out tio WHERE tio.IS_DEL=0 AND tio.IN_INVOICE_ID IN (SELECT tii.IN_INVOICE_ID FROM tt_in_invoice tii WHERE tii.IS_DEL=0 AND tii.ITEM_ID =t.`ITEM_ID`)  
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tio.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tio.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tio.CREATE_DATE
</if> 
  )IN_OUT_TAX,
  SUM((
   SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.TAX_ADJUSTMENT_ID IN 
   (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE =2 )
    AND tta.DK_STATE =1 AND tta.IS_DEL = 0
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tta.APPROVAL_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tta.APPROVAL_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tta.APPROVAL_DATE
</if>
  )) TAX_ADJUSTMENT,
  CASE
    WHEN TIMESTAMPDIFF(MONTH,(SELECT tii.TAX_DATE FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 ),NOW())&lt;=12
    THEN (
          SELECT SUM(tii.TAX_MONEY*0.6) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 
          AND 12>= TIMESTAMPDIFF(MONTH,tii.TAX_DATE,NOW())
      <if test="seachDate ==null or seachDate == '' ">
          AND NOW() >=tii.RZ_DATE 
      </if>
      <if test="seachDate !=null and seachDate != '' ">
      	  AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
      </if> 
         )
    ELSE (
          SELECT SUM(tii.TAX_MONEY*0.4) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 
      <if test="seachDate ==null or seachDate == '' "> 
          AND TIMESTAMPDIFF(MONTH,tii.TAX_DATE,NOW()) >= 13
      </if>
      <if test="seachDate !=null and seachDate != '' ">
      	  AND TIMESTAMPDIFF(MONTH,tii.TAX_DATE, LAST_DAY( #{seachDate} ) ) = 13
      </if>
         )
  END ESTATE_MONEY,
  t.`ITEM_ID`,
  (SELECT ITEM_NAME FROM tt_iteminfo ti WHERE ti.ITEM_ID = t.ITEM_ID) ITEM_NAME,
  (SELECT ti.TAXATION_TYPE FROM tt_iteminfo ti WHERE ti.ITEM_ID = t.ITEM_ID) TAXATION_TYPE,
  t.STRUCT_ID
FROM
  tt_bill_apply t 
WHERE  t.`IS_DEL` = 0
AND t.STATE >= 7
GROUP BY t.`ITEM_ID`
) sa
) ch
) a
GROUP BY a.STRUCT_ID
</select>

<select id="aObjForTaxCollection" parameterType="pd" resultType="pd">
SELECT *,
	'0' DECLARE_RETAINED,
	SETTLEMENT_TAX - TAX_RETAINED - DECLARE_NO_BILL  DECLARE_SETTLEMENT
FROM (
SELECT 
   #{structId,jdbcType=VARCHAR} STRUCT_ID,
   (SELECT s.STRUCT_NAME FROM sys_structinfo s WHERE s.STRUCT_ID = #{structId,jdbcType=VARCHAR}) STRUCT_NAME,
   SUM(OUT_TAX_NO_INCLUDED_3 ) OUT_TAX_NO_INCLUDED_3,
   SUM(OUT_TAX_MONEY_3 )       OUT_TAX_MONEY_3,
   SUM(OUT_INVOICE_MONEY_3 )   OUT_INVOICE_MONEY_3, 
   SUM(OUT_TAX_NO_INCLUDED_11 ) OUT_TAX_NO_INCLUDED_11,
   SUM(OUT_TAX_MONEY_11 )       OUT_TAX_MONEY_11,
   SUM(OUT_INVOICE_MONEY_11 )   OUT_INVOICE_MONEY_11,
   SUM(PACT_MONEY_1 ) PACT_MONEY_1,
   SUM(PACT_MONEY_0 ) PACT_MONEY_0,
   SUM(ADD_TAX_MONEY  ) ADD_TAX_MONEY ,
   SUM(PAY_TAX_3 ) PAY_TAX_3,
   SUM(PAY_TAX_2 ) PAY_TAX_2,
   SUM(IN_TAX_RZ ) IN_TAX_RZ,
   SUM(IN_OUT_TAX ) IN_OUT_TAX,
   (SELECT SUM(tii.`TAX_MONEY`) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.`ITEM_ID`=ti.`ITEM_ID` 
   WHERE tii.`ITEM_ID` NOT IN (SELECT tba.`ITEM_ID` FROM tt_bill_apply tba WHERE tba.`IS_DEL`=0 AND tba.`STATE`>=7)
   AND tii.`IS_DEL`=0 AND ti.`TAXATION_TYPE`=0
<if test="isManager == 'no'"> 
    AND tii.STRUCT_ID = #{structId,jdbcType=VARCHAR} 
</if>   
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
   ) DECLARE_NO_BILL,
   (
    SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID 
    WHERE tii.IS_DEL=0 AND tii.STATE>=1 AND ti.TAXATION_TYPE = 0 
<if test="isManager == 'no'"> 
    AND tii.STRUCT_ID = #{structId,jdbcType=VARCHAR} 
</if>   
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
   ) IN_TAX_MONEY,
   SUM((
   CASE 
     WHEN 0 > SETTLEMENT_TAX AND TAXATION_TYPE != 1
     THEN 0
     ELSE SETTLEMENT_TAX
    END 
    )) SETTLEMENT_TAX,
   SUM((
   CASE
    WHEN 0 >TAX_RETAINED
    THEN 0
    ELSE TAX_RETAINED
   END
   ))  TAX_RETAINED,
   SUM(IN_DECLARE_MONEY ) IN_DECLARE_MONEY
FROM (
SELECT 
  ch.*,
  ROUND((
  CASE
   WHEN TAXATION_TYPE = 1
   THEN 0 
   WHEN SETTLEMENT_TAX>0
   THEN 0
   ELSE IFNULL(IN_TAX_RZ,0) - IFNULL(ADD_TAX_MONEY,0) + IFNULL(PAY_TAX,0) - IFNULL(IN_OUT_TAX,0) - IFNULL(TAX_ADJUSTMENT,0)
  END 
  ),2) TAX_RETAINED,
  ROUND((
  CASE 
   WHEN TAXATION_TYPE = 1
   THEN 0
   WHEN SETTLEMENT_TAX>0
   THEN IN_TAX_RZ
   ELSE  IFNULL(ADD_TAX_MONEY,0) -  IFNULL(PAY_TAX,0) + IFNULL(IN_OUT_TAX,0) + IFNULL(TAX_ADJUSTMENT,0)
  END
  ),2) IN_DECLARE_MONEY
FROM(
SELECT 
  sa.*,
  ROUND(
     IFNULL(ADD_TAX_MONEY_0  * 0.11,0) +
     IFNULL( ((IFNULL(ADD_TAX_MONEY_1,0) - IFNULL(PACT_TAX_NO_MONEY_1,0) ) * 0.03),0)
   ,2) ADD_TAX_MONEY,
  ROUND(
     IFNULL(ADD_TAX_MONEY_0 * 0.11,0) +IFNULL( ((IFNULL(ADD_TAX_MONEY_1,0) - IFNULL(PACT_TAX_NO_MONEY_1,0) ) * 0.03),0) -
        IFNULL(PAY_TAX_3,0) -  IFNULL(PAY_TAX_2,0) -  IFNULL(IN_TAX,0) -  IFNULL(ESTATE_MONEY,0)  +  IFNULL(IN_OUT_TAX ,0)+  IFNULL(TAX_ADJUSTMENT,0)
   ,2) SETTLEMENT_TAX,
   IFNULL(PAY_TAX_3,0) +  IFNULL(PAY_TAX_2,0) PAY_TAX,
   IFNULL(IN_TAX,0) + IFNULL(ESTATE_MONEY,0) IN_TAX_RZ 
FROM (
SELECT 
  SUM((
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  ))OUT_TAX_NO_INCLUDED_3,
  SUM((
   SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_MONEY_3,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY + toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_INVOICE_MONEY_3,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_NO_INCLUDED_11,
  SUM((
   SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_MONEY_11,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY + toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_INVOICE_MONEY_11,
  (
    SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 1 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
  )PACT_MONEY_1,
  (
    SELECT SUM(tii.TAX_NO_INCLUDED) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 1 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>    
  )PACT_TAX_NO_MONEY_1,
  (
    SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 0 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
  )PACT_MONEY_0,
  (
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi LEFT JOIN tt_iteminfo ti ON toi.ITEM_ID = ti.ITEM_ID WHERE toi.IS_DEL = 0 AND toi.BILL_APPLY_ID IS NOT NULL AND toi.BILL_APPLY_ID !=''  
   AND ti.TAXATION_TYPE =0 AND toi.ITEM_ID = t.`ITEM_ID`
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )ADD_TAX_MONEY_0,
  (
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi LEFT JOIN tt_iteminfo ti ON toi.ITEM_ID = ti.ITEM_ID WHERE toi.IS_DEL = 0 AND toi.BILL_APPLY_ID IS NOT NULL AND toi.BILL_APPLY_ID !=''  
   AND ti.TAXATION_TYPE =1 AND toi.ITEM_ID = t.`ITEM_ID`
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )ADD_TAX_MONEY_1,
  SUM((
   SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE t.`BILL_APPLY_ID` = tpt.BILL_APPLY_ID AND tpt.IS_DEL=0 AND (tpt.RATE_MONEY =2 OR tpt.RATE_MONEY =11) 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tpt.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tpt.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tpt.CREATE_DATE
</if>
   )) PAY_TAX_2,
  SUM((
   SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE t.`BILL_APPLY_ID` = tpt.BILL_APPLY_ID AND tpt.IS_DEL=0 AND tpt.RATE_MONEY =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tpt.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tpt.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tpt.CREATE_DATE
</if>   
   )) PAY_TAX_3,
  (
   SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID WHERE tii.IS_DEL=0 
   AND ti.TAXATION_TYPE =0 AND tii.IN_STATE =0 AND tii.ITEM_ID = t.`ITEM_ID` AND tii.STATE>=1 AND  tii.IS_ESTATE = 0
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>  
  )IN_TAX,
  (
   SELECT SUM(tio.TAX_MONEY) FROM tt_invoice_out tio WHERE tio.IS_DEL=0 AND tio.IN_INVOICE_ID IN (SELECT tii.IN_INVOICE_ID FROM tt_in_invoice tii WHERE tii.IS_DEL=0 AND tii.ITEM_ID =t.`ITEM_ID`)  
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tio.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tio.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tio.CREATE_DATE
</if> 
  )IN_OUT_TAX,
  SUM((
   SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.TAX_ADJUSTMENT_ID IN 
   (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE =2 )
    AND tta.DK_STATE =1 AND tta.IS_DEL = 0
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tta.APPROVAL_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tta.APPROVAL_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tta.APPROVAL_DATE
</if>
  )) TAX_ADJUSTMENT,
  CASE
    WHEN TIMESTAMPDIFF(MONTH,(SELECT tii.TAX_DATE FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 ),NOW())&lt;=12
    THEN (
          SELECT SUM(tii.TAX_MONEY*0.6) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 
          AND 12>= TIMESTAMPDIFF(MONTH,tii.TAX_DATE,NOW())
      <if test="seachDate ==null or seachDate == '' ">
          AND NOW() >=tii.RZ_DATE 
      </if>
      <if test="seachDate !=null and seachDate != '' ">
      	  AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
      </if> 
         )
    ELSE (
          SELECT SUM(tii.TAX_MONEY*0.4) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 
      <if test="seachDate ==null or seachDate == '' "> 
          AND TIMESTAMPDIFF(MONTH,tii.TAX_DATE,NOW()) >= 13
      </if>
      <if test="seachDate !=null and seachDate != '' ">
      	  AND TIMESTAMPDIFF(MONTH,tii.TAX_DATE, LAST_DAY( #{seachDate} ) ) = 13
      </if>
         )
  END ESTATE_MONEY,
  t.`ITEM_ID`,
  (SELECT ITEM_NAME FROM tt_iteminfo ti WHERE ti.ITEM_ID = t.ITEM_ID) ITEM_NAME,
  (SELECT ti.TAXATION_TYPE FROM tt_iteminfo ti WHERE ti.ITEM_ID = t.ITEM_ID) TAXATION_TYPE,
  t.STRUCT_ID
FROM
  tt_bill_apply t 
WHERE  t.`IS_DEL` = 0
AND t.STATE >= 7
GROUP BY t.`ITEM_ID`
) sa
) ch
) a
WHERE 1=1
<if test="isManager == 'no'">
 AND STRUCT_ID =  #{structId,jdbcType=VARCHAR}
</if>
) b
</select>

<select id="listTaxCollectionForItem" parameterType="pd" resultType="pd">
SELECT 
  ch.*,
  ROUND((
  CASE 
   WHEN TAXATION_TYPE = 1
   THEN 0
   WHEN SETTLEMENT_TAX>0
   THEN 0
   ELSE IFNULL(IN_TAX_RZ,0) - IFNULL(ADD_TAX_MONEY,0) + IFNULL(PAY_TAX,0) - IFNULL(IN_OUT_TAX,0) - IFNULL(TAX_ADJUSTMENT,0)
  END 
  ),2) TAX_RETAINED,
  ROUND((
  CASE 
   WHEN TAXATION_TYPE = 1
   THEN 0
   WHEN SETTLEMENT_TAX>0
   THEN IN_TAX_RZ
   ELSE IFNULL(ADD_TAX_MONEY,0) - IFNULL(PAY_TAX,0) + IFNULL(IN_OUT_TAX,0) + IFNULL(TAX_ADJUSTMENT,0)
  END
  ),2) IN_DECLARE_MONEY,
  (
    SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID 
    WHERE tii.IS_DEL=0 AND tii.STATE>=1 AND ti.TAXATION_TYPE = 0 AND tii.ITEM_ID = ch.ITEM_ID 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
   ) IN_TAX_MONEY
FROM(
SELECT 
  sa.*,
  ROUND(
     IFNULL(ADD_TAX_MONEY_0  * 0.11,0) +
     IFNULL( ((IFNULL(ADD_TAX_MONEY_1,0) - IFNULL(PACT_TAX_NO_MONEY_1,0) ) * 0.03),0)
   ,2) ADD_TAX_MONEY,
  ROUND(
     IFNULL(ADD_TAX_MONEY_0 * 0.11,0) +IFNULL( ((IFNULL(ADD_TAX_MONEY_1,0) - IFNULL(PACT_TAX_NO_MONEY_1,0) ) * 0.03),0) -
        IFNULL(PAY_TAX_3,0) -  IFNULL(PAY_TAX_2,0) -  IFNULL(IN_TAX,0) -  IFNULL(ESTATE_MONEY,0)  +  IFNULL(IN_OUT_TAX ,0)+  IFNULL(TAX_ADJUSTMENT,0)
   ,2) SETTLEMENT_TAX,
   IFNULL(PAY_TAX_3,0) +  IFNULL(PAY_TAX_2,0) PAY_TAX,
   IFNULL(IN_TAX,0) + IFNULL(ESTATE_MONEY,0) IN_TAX_RZ 
FROM (
SELECT 
  SUM((
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  ))OUT_TAX_NO_INCLUDED_3,
  SUM((
   SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_MONEY_3,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY + toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_INVOICE_MONEY_3,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_NO_INCLUDED_11,
  SUM((
   SELECT SUM(toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_TAX_MONEY_11,
  SUM((
   SELECT SUM(toi.INVOICE_MONEY + toi.TAX_MONEY) FROM tt_output_invoice toi WHERE toi.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND toi.IS_DEL=0 AND toi.TAX_RATE =11
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )) OUT_INVOICE_MONEY_11,
  (
    SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 1 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
  )PACT_MONEY_1,
  (
    SELECT SUM(tii.TAX_NO_INCLUDED) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 1 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>    
  )PACT_TAX_NO_MONEY_1,
  (
    SELECT SUM(tii.INVOICE_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID  WHERE tii.IS_DEL=0 
    AND tii.IN_INVOICE_ID IN (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit 
    WHERE tit.BILL_APPLY_ID IN (SELECT tba.BILL_APPLY_ID FROM tt_bill_apply tba WHERE tba.STATE>=7 AND tba.ITEM_ID = t.ITEM_ID)) AND ti.TAXATION_TYPE = 0 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>
  )PACT_MONEY_0,
  (
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi LEFT JOIN tt_iteminfo ti ON toi.ITEM_ID = ti.ITEM_ID WHERE toi.IS_DEL = 0 AND toi.BILL_APPLY_ID IS NOT NULL AND toi.BILL_APPLY_ID !=''  
   AND ti.TAXATION_TYPE =0 AND toi.ITEM_ID = t.`ITEM_ID`
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )ADD_TAX_MONEY_0,
  (
   SELECT SUM(toi.INVOICE_MONEY) FROM tt_output_invoice toi LEFT JOIN tt_iteminfo ti ON toi.ITEM_ID = ti.ITEM_ID WHERE toi.IS_DEL = 0 AND toi.BILL_APPLY_ID IS NOT NULL AND toi.BILL_APPLY_ID !=''  
   AND ti.TAXATION_TYPE =1 AND toi.ITEM_ID = t.`ITEM_ID`
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=toi.TAX_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND toi.TAX_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=toi.TAX_DATE
</if>
  )ADD_TAX_MONEY_1,
  SUM((
   SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE t.`BILL_APPLY_ID` = tpt.BILL_APPLY_ID AND tpt.IS_DEL=0 AND (tpt.RATE_MONEY =2 OR tpt.RATE_MONEY =11) 
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tpt.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tpt.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tpt.CREATE_DATE
</if>
   )) PAY_TAX_2,
  SUM((
   SELECT SUM(tpt.TAX_MONEY) FROM tt_pay_tax tpt WHERE t.`BILL_APPLY_ID` = tpt.BILL_APPLY_ID AND tpt.IS_DEL=0 AND tpt.RATE_MONEY =3
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tpt.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tpt.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tpt.CREATE_DATE
</if>   
   )) PAY_TAX_3,
  (
   SELECT SUM(tii.TAX_MONEY) FROM tt_in_invoice tii LEFT JOIN tt_iteminfo ti ON tii.ITEM_ID = ti.ITEM_ID WHERE tii.IS_DEL=0 
   AND ti.TAXATION_TYPE =0 AND tii.IN_STATE =0 AND tii.ITEM_ID = t.`ITEM_ID` AND tii.STATE>=1 AND  tii.IS_ESTATE = 0
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tii.RZ_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
</if>  
  )IN_TAX,
  (
   SELECT SUM(tio.TAX_MONEY) FROM tt_invoice_out tio WHERE tio.IS_DEL=0 AND tio.IN_INVOICE_ID IN (SELECT tii.IN_INVOICE_ID FROM tt_in_invoice tii WHERE tii.IS_DEL=0 AND tii.ITEM_ID =t.`ITEM_ID`)  
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tio.CREATE_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tio.CREATE_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tio.CREATE_DATE
</if> 
  )IN_OUT_TAX,
  SUM((
   SELECT SUM(tta.TAX) FROM tt_tax_adjustment tta WHERE tta.TAX_ADJUSTMENT_ID IN 
   (SELECT tit.IN_INVOICE_ID FROM tt_invoice_type tit WHERE tit.BILL_APPLY_ID = t.`BILL_APPLY_ID` AND tit.IS_SUBPACKAGE =2 )
    AND tta.DK_STATE =1 AND tta.IS_DEL = 0
<if test="seachDate ==null or seachDate == '' ">
    AND NOW() >=tta.APPROVAL_DATE
</if>
<if test="seachDate !=null and seachDate != '' ">
	AND tta.APPROVAL_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tta.APPROVAL_DATE
</if>
  )) TAX_ADJUSTMENT,
  CASE
    WHEN TIMESTAMPDIFF(MONTH,(SELECT tii.TAX_DATE FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 ),NOW())&lt;=12
    THEN (
          SELECT SUM(tii.TAX_MONEY*0.6) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 
          AND 12>= TIMESTAMPDIFF(MONTH,tii.TAX_DATE,NOW())
      <if test="seachDate ==null or seachDate == '' ">
          AND NOW() >=tii.RZ_DATE 
      </if>
      <if test="seachDate !=null and seachDate != '' ">
      	  AND tii.RZ_DATE>=DATE_FORMAT( #{seachDate} , '%Y-%m-01') AND LAST_DAY( #{seachDate} )>=tii.RZ_DATE
      </if> 
         )
    ELSE (
          SELECT SUM(tii.TAX_MONEY*0.4) FROM tt_in_invoice tii WHERE tii.ITEM_ID = t.ITEM_ID AND tii.IS_ESTATE = 1 AND tii.IS_DEL=0 AND tii.STATE>=1 
      <if test="seachDate ==null or seachDate == '' "> 
          AND TIMESTAMPDIFF(MONTH,tii.TAX_DATE,NOW()) >= 13
      </if>
      <if test="seachDate !=null and seachDate != '' ">
      	  AND TIMESTAMPDIFF(MONTH,tii.TAX_DATE, LAST_DAY( #{seachDate} ) ) = 13
      </if>
         )
  END ESTATE_MONEY,
  t.`ITEM_ID`,
  (SELECT ITEM_NAME FROM tt_iteminfo ti WHERE ti.ITEM_ID = t.ITEM_ID) ITEM_NAME,
  (SELECT ti.TAXATION_TYPE FROM tt_iteminfo ti WHERE ti.ITEM_ID = t.ITEM_ID) TAXATION_TYPE
FROM
  tt_bill_apply t 
WHERE  t.`IS_DEL` = 0
AND t.STATE >= 7
AND t.STRUCT_ID = #{STRUCT_ID,jdbcType=VARCHAR} 
GROUP BY t.`ITEM_ID`
) sa
) ch

</select>

<select id="listInvoice" parameterType="pd" resultType="pd">
SELECT 
  sa.*,
  CASE
    TAXATION_TYPE 
    WHEN 0 
    THEN ROUND((2 / 11) * 100, 2) 
    ELSE 0 
  END PAY_TAX_PROPORTION,
  CASE
    TAXATION_TYPE 
    WHEN 0 
    THEN (
      JXDK_PACT_TAX_MONEY_TWO + JXDK_IN_TAX_MONEY_TWO
    ) 
    WHEN 1 
    THEN 0 
  END JXDK_MONEY,
  CASE
    TAXATION_TYPE 
    WHEN 0 
    THEN ROUND(
      (
        (
          JXDK_IN_TAX_MONEY_TWO + JXDK_PACT_TAX_MONEY_TWO
        ) / ((OUT_MONEY / (1+0.11)) * 0.11)
      ) * 100,
      2
    ) 
    WHEN 1 
    THEN ROUND(
      (
        (0+ JXDK_PACT_TAX_MONEY_TWO) / ((OUT_MONEY / (1+0.3)) * 0.3)
      ) * 100,
      2
    ) 
  END JXDK_PROPORTION,
  CASE
    sa.TAXATION_TYPE 
    WHEN 0 
    THEN ROUND((BILL_MONEY / (1+0.11)) * 0.11, 2) 
    ELSE 0 
  END TPS_ADD_TAX_MONEY,
  CASE
    TAXATION_TYPE 
    WHEN 0 
    THEN ROUND(
      (
        1 - 2 / 11 - (
          JXDK_IN_TAX_MONEY_TWO + JXDK_PACT_TAX_MONEY_TWO
        ) / ((OUT_MONEY / (1+0.11)) * 0.11)
      ) * 100,
      2
    ) 
    ELSE 0 
  END TPS_MONEY_PROPORTION,
  (
    JXLD_TAX_MONEY_ONE - JXLD_TAX_MONEY_TWO
  ) JXLD_MONEY,
  (JXDD_IN_MONEY - JXDD_IN_D_MONEY) JXDD_MONEY 
FROM
  (SELECT 
    (SELECT 
      IFNULL(SUM(toi.INVOICE_MONEY), 0) 
    FROM
      tt_output_invoice toi 
    WHERE toi.IS_DEL = 0 
      AND toi.ITEM_ID = t.ITEM_ID 
      AND toi.BILL_APPLY_ID IN 
      (SELECT 
        tba.BILL_APPLY_ID 
      FROM
        tt_bill_apply tba 
      WHERE tba.IS_DEL = 0 
        AND tba.STATE = 5)) OUT_MONEY,
    SUM(
      (SELECT 
        IFNULL(SUM(TAX_MONEY), 0) 
      FROM
        tt_pay_tax tpt 
      WHERE tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID`)
    ) PAY_TAX_MONEY,
    CASE
      ti.`TAXATION_TYPE` 
      WHEN 0 
      THEN 0.11 
      WHEN 1 
      THEN 0.03 
    END TAXATION_TYPE_INFO,
    ti.ITEM_NAME,
    IFNULL(
      SUM(
        (SELECT 
          SUM(tii.INVOICE_MONEY) 
        FROM
          tt_in_invoice tii 
        WHERE tii.FOREIGN_KEY IN 
          (SELECT 
            tp.PACT_ID 
          FROM
            tt_pactinfo tp 
          WHERE tp.PACT_TYPE IN ('3002', '3005')) 
          AND tii.ITEM_ID = t.ITEM_ID 
          AND tii.`IS_DEL` = 0 
          AND tii.`STATE` >= 3)
      ),
      0
    ) PACT_MONEY,
    (SELECT 
      IFNULL(SUM(tii.TAX_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.FOREIGN_KEY IN 
      (SELECT 
        tp.PACT_ID 
      FROM
        tt_pactinfo tp 
      WHERE tp.PACT_TYPE IN ('3002', '3005')) 
      AND tii.ITEM_ID = t.ITEM_ID 
      AND tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 3) JXDK_PACT_TAX_MONEY_TWO,
    (SELECT 
      IFNULL(SUM(tii.TAX_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.FOREIGN_KEY NOT IN 
      (SELECT 
        tp.PACT_ID 
      FROM
        tt_pactinfo tp 
      WHERE tp.PACT_TYPE IN ('3002', '3005')) 
      AND tii.ITEM_ID = t.ITEM_ID 
      AND tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 3) JXDK_IN_TAX_MONEY_TWO,
    ti.`TAXATION_TYPE`,
    (SELECT 
      IFNULL(SUM(tps.INVOICE_MONEY), 0) 
    FROM
      tt_pay_settlement tps 
    WHERE tps.`BILL_APPLY_ID` = t.BILL_APPLY_ID 
      AND tps.`IS_DEL` = 0) TPS_ADD_INVOICE_MONEY,
    SUM(
      (SELECT 
        ROUND(
          IFNULL(
            SUM(
              CASE
                tii.`IS_ESTATE` 
                WHEN 0 
                THEN tii.TAX_MONEY 
                WHEN 1 
                THEN tii.TAX_MONEY * 0.6 
              END
            ),
            0
          ),
          2
        ) 
      FROM
        tt_in_invoice tii 
      WHERE tii.`IS_DEL` = 0 
        AND tii.`STATE` >= 1 
        AND tii.ITEM_ID = t.ITEM_ID)
    ) JXLD_TAX_MONEY_ONE,
    SUM(
      (SELECT 
        ROUND(
          IFNULL(
            SUM(
              CASE
                tii.`IS_ESTATE` 
                WHEN 0 
                THEN tii.TAX_MONEY 
                WHEN 1 
                THEN tii.TAX_MONEY * 0.6 
              END
            ),
            0
          ),
          2
        ) 
      FROM
        tt_in_invoice tii 
      WHERE tii.`IS_DEL` = 0 
        AND tii.`STATE` >= 2 
        AND tii.ITEM_ID = t.ITEM_ID)
    ) JXLD_TAX_MONEY_TWO,
    SUM((SELECT 
      IFNULL(SUM(tii.TAX_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 1 
      AND tii.`IS_ESTATE` = 1 
      AND TIMESTAMPDIFF(YEAR, tii.`TAX_DATE`, NOW()) > 0)) JXDD_IN_MONEY,
    SUM((SELECT 
      IFNULL(SUM(tii.D_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 1 
      AND tii.`IS_ESTATE` = 1 
      AND TIMESTAMPDIFF(YEAR, tii.`TAX_DATE`, NOW()) > 0)) JXDD_IN_D_MONEY,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 1 
          AND ttl.STATE = 1 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) YJ_ENTERPRISE,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 1 
          AND ttl.STATE = 0 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) QJ_ENTERPRISE,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 2 
          AND ttl.STATE = 1 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) YJ_PERSONAL,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 2 
          AND ttl.STATE = 0 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) QJ_PERSONAL,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 0 
          AND ttl.STATE = 1 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) YJ_MANAGE,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 0 
          AND ttl.STATE = 0 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) QJ_MANAGE,
    t.ITEM_ID,
    t.STRUCT_ID,
    SUM(t.BILL_MONEY) BILL_MONEY 
  FROM
    tt_bill_apply t,
    tt_iteminfo ti 
  WHERE t.`ITEM_ID` = ti.`ITEM_ID` 
    AND t.IS_DEL = 0 
    AND t.STATE = 5) sa 
WHERE 1 = 1 
  AND ITEM_ID = #{ZD_ID}
</select>


<select id="listInvoiceALL" parameterType="pd" resultType="pd">
SELECT 
  sa.STRUCT_ID,
  SUM(
    CASE
      TAXATION_TYPE 
      WHEN 0 
      THEN (
        JXDK_PACT_TAX_MONEY_TWO + JXDK_IN_TAX_MONEY_TWO
      ) 
      WHEN 1 
      THEN 0 
    END
  ) JXDK_MONEY,
  SUM(JXDK_IN_TAX_MONEY_TWO) JXDK_IN_TAX_MONEY_TWO,
  SUM(JXDK_PACT_TAX_MONEY_TWO) JXDK_PACT_TAX_MONEY_TWO,
  SUM(
    CASE
      TAXATION_TYPE 
      WHEN 0 
      THEN ROUND((BILL_MONEY / (1+0.11)) * 0.11, 2) 
      ELSE 0 
    END
  ) TPS_ADD_TAX_MONEY,
  SUM(TPS_ADD_INVOICE_MONEY) TPS_ADD_INVOICE_MONEY,
  SUM(
    JXLD_TAX_MONEY_ONE - JXLD_TAX_MONEY_TWO
  ) JXLD_MONEY,
  SUM(OUT_MONEY) OUT_MONEY,
  SUM(PACT_MONEY) PACT_MONEY,
  SUM(PAY_TAX_MONEY) PAY_TAX_MONEY,
  SUM(YJ_ENTERPRISE) YJ_ENTERPRISE,
  SUM(QJ_ENTERPRISE) QJ_ENTERPRISE,
  SUM(YJ_PERSONAL) YJ_PERSONAL,
  SUM(QJ_PERSONAL) QJ_PERSONAL,
  SUM(YJ_MANAGE) YJ_MANAGE,
  SUM(QJ_MANAGE) QJ_MANAGE,
  SUM(JXDD_IN_MONEY) JXDD_IN_MONEY,
  SUM(JXDD_IN_MONEY - JXDD_IN_D_MONEY) JXDD_MONEY,
  SUM(BILL_MONEY) BILL_MONEY 
FROM
  (SELECT 
    (SELECT 
      IFNULL(SUM(toi.INVOICE_MONEY), 0) 
    FROM
      tt_output_invoice toi 
    WHERE toi.IS_DEL = 0 
      AND toi.ITEM_ID = t.ITEM_ID 
      AND toi.BILL_APPLY_ID IN 
      (SELECT 
        tba.BILL_APPLY_ID 
      FROM
        tt_bill_apply tba 
      WHERE tba.IS_DEL = 0 
        AND tba.STATE = 5)) OUT_MONEY,
    SUM(
      (SELECT 
        IFNULL(SUM(TAX_MONEY), 0) 
      FROM
        tt_pay_tax tpt 
      WHERE tpt.BILL_APPLY_ID = t.`BILL_APPLY_ID`)
    ) PAY_TAX_MONEY,
    CASE
      ti.`TAXATION_TYPE` 
      WHEN 0 
      THEN 0.11 
      WHEN 1 
      THEN 0.03 
    END TAXATION_TYPE_INFO,
    ti.ITEM_NAME,
    IFNULL(
      SUM(
        (SELECT 
          SUM(tii.INVOICE_MONEY) 
        FROM
          tt_in_invoice tii 
        WHERE tii.FOREIGN_KEY IN 
          (SELECT 
            tp.PACT_ID 
          FROM
            tt_pactinfo tp 
          WHERE tp.PACT_TYPE IN ('3002', '3005')) 
          AND tii.ITEM_ID = t.ITEM_ID 
          AND tii.`IS_DEL` = 0 
          AND tii.`STATE` >= 3)
      ),
      0
    ) PACT_MONEY,
    (SELECT 
      IFNULL(SUM(tii.TAX_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.FOREIGN_KEY IN 
      (SELECT 
        tp.PACT_ID 
      FROM
        tt_pactinfo tp 
      WHERE tp.PACT_TYPE IN ('3002', '3005')) 
      AND tii.ITEM_ID = t.ITEM_ID 
      AND tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 3) JXDK_PACT_TAX_MONEY_TWO,
    (SELECT 
      IFNULL(SUM(tii.TAX_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.FOREIGN_KEY NOT IN 
      (SELECT 
        tp.PACT_ID 
      FROM
        tt_pactinfo tp 
      WHERE tp.PACT_TYPE IN ('3002', '3005')) 
      AND tii.ITEM_ID = t.ITEM_ID 
      AND tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 3) JXDK_IN_TAX_MONEY_TWO,
    ti.`TAXATION_TYPE`,
    (SELECT 
      IFNULL(SUM(tps.INVOICE_MONEY), 0) 
    FROM
      tt_pay_settlement tps 
    WHERE tps.`BILL_APPLY_ID` = t.BILL_APPLY_ID 
      AND tps.`IS_DEL` = 0) TPS_ADD_INVOICE_MONEY,
    SUM(
      (SELECT 
        ROUND(
          IFNULL(
            SUM(
              CASE
                tii.`IS_ESTATE` 
                WHEN 0 
                THEN tii.TAX_MONEY 
                WHEN 1 
                THEN tii.TAX_MONEY * 0.6 
              END
            ),
            0
          ),
          2
        ) 
      FROM
        tt_in_invoice tii 
      WHERE tii.`IS_DEL` = 0 
        AND tii.`STATE` >= 1 
        AND tii.ITEM_ID = t.ITEM_ID)
    ) JXLD_TAX_MONEY_ONE,
    SUM(
      (SELECT 
        ROUND(
          IFNULL(
            SUM(
              CASE
                tii.`IS_ESTATE` 
                WHEN 0 
                THEN tii.TAX_MONEY 
                WHEN 1 
                THEN tii.TAX_MONEY * 0.6 
              END
            ),
            0
          ),
          2
        ) 
      FROM
        tt_in_invoice tii 
      WHERE tii.`IS_DEL` = 0 
        AND tii.`STATE` >= 2 
        AND tii.ITEM_ID = t.ITEM_ID)
    ) JXLD_TAX_MONEY_TWO,
    SUM((SELECT 
      IFNULL(SUM(tii.TAX_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 1 
      AND tii.`IS_ESTATE` = 1 
      AND TIMESTAMPDIFF(YEAR, tii.`TAX_DATE`, NOW()) > 0)) JXDD_IN_MONEY,
    SUM((SELECT 
      IFNULL(SUM(tii.D_MONEY), 0) 
    FROM
      tt_in_invoice tii 
    WHERE tii.`IS_DEL` = 0 
      AND tii.`STATE` >= 1 
      AND tii.`IS_ESTATE` = 1 
      AND TIMESTAMPDIFF(YEAR, tii.`TAX_DATE`, NOW()) > 0)) JXDD_IN_D_MONEY,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 1 
          AND ttl.STATE = 1 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) YJ_ENTERPRISE,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 1 
          AND ttl.STATE = 0 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) QJ_ENTERPRISE,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 2 
          AND ttl.STATE = 1 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) YJ_PERSONAL,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 2 
          AND ttl.STATE = 0 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) QJ_PERSONAL,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 0 
          AND ttl.STATE = 1 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) YJ_MANAGE,
    IFNULL(
      SUM(
        (SELECT 
          ttl.`MONEY` 
        FROM
          tt_taxation_list ttl 
        WHERE ttl.`TYPE` = 0 
          AND ttl.STATE = 0 
          AND ttl.`BILL_APPLY_ID` = t.`BILL_APPLY_ID`)
      ),
      0
    ) QJ_MANAGE,
    t.ITEM_ID,
    t.STRUCT_ID,
    SUM(t.BILL_MONEY) BILL_MONEY 
  FROM
    tt_bill_apply t,
    tt_iteminfo ti 
  WHERE t.`ITEM_ID` = ti.`ITEM_ID` 
    AND t.IS_DEL = 0 
    AND t.STATE = 5
    GROUP BY ti.ITEM_ID) sa 
WHERE 1 = 1  
<if test="age !='yes'">
  and STRUCT_ID = #{ZD_ID}
GROUP BY sa.STRUCT_ID 
</if>
</select>



</mapper>